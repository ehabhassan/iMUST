MODULE SYSGRAPHICS
 USE SYSINFO
 USE MATHSUBS
 USE DOPERATORS
 USE SYSSOLVER
 USE FORTGRAPHER


 LOGICAL :: rfldPLOT=.FALSE.  ! ONLY R-FIELD
 LOGICAL :: kfldPLOT=.FALSE.  ! ONLY K-FIELD
 LOGICAL :: efldPLOT=.FALSE.  ! ENERGY SPECTRUM OF EACH FIELD
 LOGICAL :: ffldPLOT=.FALSE.  ! FLUX BETWEEN EACH TWO FIELDS


 INTERFACE PLOTPROFILE
  MODULE PROCEDURE r4r8PLOTPROFILE1D,r8r8PLOTPROFILE1D,r4r8PLOTPROFILE2D,r8r8PLOTPROFILE2D
 END INTERFACE PLOTPROFILE

 INTERFACE PLOTEIGENS
  MODULE PROCEDURE PLOTEIGENS1D,PLOTEIGENS2D
 END INTERFACE PLOTEIGENS

 INTERFACE FieldsPlot
  MODULE PROCEDURE r4r8FieldsPlot,r8r8FieldsPlot,r4FieldsPlotNETCDF,r8FieldsPlotNETCDF
 END INTERFACE FieldsPlot

 INTERFACE exFFtmat
  MODULE PROCEDURE C8exFFTmat1D,C8exFFTmat2D,C8exFFTmat3D
 END INTERFACE exFFTmat

 CONTAINS


!******************************************************************************
!            SAVE AND READ THE FIEDLS AT A CEERTAIN TIME STEP
!******************************************************************************
 SUBROUTINE SAVEFIELDS(TIMESTP,Lrfld,VARMEMSIZE)
  IMPLICIT NONE
  REAL(8), ALLOCATABLE   :: TORESTART(:,:)
  REAL(8),    INTENT(IN) :: TIMESTP
  REAL(8),    INTENT(IN) :: Lrfld(:,:,:,:)
  INTEGER(4), INTENT(IN) :: VARMEMSIZE
  INTEGER(4)             :: DATALEN,DATASIZE
  INTEGER(4)             :: MATDIMS(4)
  INTEGER(4)             :: ferror
  INTEGER(4)             :: iCOUNTER

  MATDIMS=SHAPE(Lrfld)
  DATALEN=MATDIMS(1)*MATDIMS(2)*MATDIMS(3)
  DATASIZE=(MATDIMS(4)+1)*DATALEN*VARMEMSIZE

  ALLOCATE(TORESTART(MATDIMS(4)+1,DATALEN))

  DO iCOUNTER=1,MATDIMS(4)
   TORESTART(iCOUNTER,:)=RESHAPE(Lrfld(:,:,:,iCOUNTER),(/DATALEN/))
  END DO
  TORESTART(MATDIMS(4)+1,:)=TIMESTP
  OPEN(UNIT=1,FILE="restartdata.out",STATUS='NEW',form='UNFORMATTED',ACCESS='DIRECT',IOSTAT=ferror,RECL=DATASIZE)
  IF(ferror.NE.0) OPEN(UNIT=1,FILE="restartdata.out",STATUS='REPLACE',form='UNFORMATTED',ACCESS='DIRECT',IOSTAT=ferror,RECL=DATASIZE)
  WRITE(1,rec=1) TORESTART
  CLOSE(1)

  RETURN
 END SUBROUTINE SAVEFIELDS

 SUBROUTINE READFIELDS(TIMESTP,Lrfld,VARMEMSIZE)
  IMPLICIT NONE
  REAL(8), ALLOCATABLE    :: TORESTART(:,:)
  REAL(8),    INTENT(OUT) :: TIMESTP
  REAL(8),    INTENT(OUT)  :: Lrfld(:,:,:,:)
  INTEGER(4), INTENT(IN)  :: VARMEMSIZE
  INTEGER(4)              :: DATALEN,DATASIZE
  INTEGER(4)              :: MATDIMS(4)
  INTEGER(4)              :: ferror
  INTEGER(4)              :: iCOUNTER

  MATDIMS=SHAPE(Lrfld)
  DATALEN=MATDIMS(1)*MATDIMS(2)*MATDIMS(3)
  DATASIZE=(MATDIMS(4)+1)*DATALEN*VARMEMSIZE

  ALLOCATE(TORESTART(MATDIMS(4)+1,DATALEN))

  OPEN(UNIT=1,FILE="restartdata.out",STATUS='OLD',form='UNFORMATTED',ACCESS='DIRECT',IOSTAT=ferror,RECL=DATASIZE)
  READ(1,REC=1) TORESTART
  CLOSE(1)
  DO iCOUNTER=1,MATDIMS(4)
   Lrfld(:,:,:,iCOUNTER)=RESHAPE(TORESTART(iCOUNTER,:),(/MATDIMS(1),MATDIMS(2),MATDIMS(3)/))
  END DO
  TIMESTP=TORESTART(MATDIMS(4)+1,1)

  RETURN
 END SUBROUTINE READFIELDS


!******************************************************************************
!            PLOT THE ENERGY SPECTRUM AT EVERY TIME SERIES
!******************************************************************************
 SUBROUTINE SAVEENERGY(TIMESTP,Lrfld)
  IMPLICIT NONE
  REAL(8), INTENT(IN)     :: TIMESTP
  REAL(8), INTENT(IN)     :: Lrfld(:,:,:)
  REAL(8), ALLOCATABLE    :: FLDSENERGY(:)
  COMPLEX(8), ALLOCATABLE :: Lkfld(:,:,:)
  INTEGER(4)              :: MATDIMS(3)
  INTEGER(4)              :: ferror
  INTEGER(4)              :: iCOUNTER

  MATDIMS=SHAPE(Lrfld)
  ALLOCATE(Lkfld(MATDIMS(1)/2+1,MATDIMS(2),MATDIMS(3)))
  ALLOCATE(FLDSENERGY(MATDIMS(3)+2))
  FLDSENERGY=0.0d0

  OPEN(UNIT=101,FILE="energySpectrum.out",ACTION='WRITE',FORM='FORMATTED', &
  &    STATUS='OLD',ACCESS='SEQUENTIAL',POSITION='APPEND',IOSTAT=ferror)
  IF(ferror.NE.0) THEN
   OPEN(UNIT=101,FILE="energySpectrum.out",ACTION='WRITE',FORM='FORMATTED', &
   &    STATUS='NEW',ACCESS='SEQUENTIAL',POSITION='APPEND',IOSTAT=ferror)
  END IF
  FLDSENERGY(1)=TIMESTP
  DO iCOUNTER=1,MATDIMS(3)  
  !CALL FORWARDFFTW(Lrfld(:,:,iCOUNTER),Lkfld(:,:,iCOUNTER))
   CALL FFTW(Lrfld(:,:,iCOUNTER),Lkfld(:,:,iCOUNTER))
   FLDSENERGY(iCOUNTER+1)=SUM(CDABS(Lkfld(:,:,iCOUNTER)*DCONJG(Lkfld(:,:,iCOUNTER))))
   FLDSENERGY(MATDIMS(3)+2)=FLDSENERGY(MATDIMS(3)+2)+FLDSENERGY(iCOUNTER+1)
  END DO
  WRITE(101,'(5ES15.7)') FLDSENERGY
  CLOSE(101)

  RETURN
 END SUBROUTINE SAVEENERGY

 SUBROUTINE PLOTENERGYSPECTRUM(Lnfld,ENERGYfNAME)
  IMPLICIT NONE
  CHARACTER(*), INTENT(IN) :: ENERGYfNAME
  REAL(8), ALLOCATABLE     :: ENERGYDATA(:,:)
  REAL(8)                  :: TEMPDBLE
  INTEGER(4)               :: MATDIMS(2)
  INTEGER(4)               :: ferror,fnLINES
  INTEGER(4)               :: iCOUNTER
  INTEGER(4),   INTENT(IN) :: Lnfld
  LOGICAL                  :: EOFILE=.FALSE.
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)               :: GFC(10)
  CHARACTER*100            :: GA(20)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=50
  GFC(PLTFIGNUM)=1
  GFC(PLTSFIGNUM)=111
  GFC(PLTFIGHOLD)=GETVALOF("NO")
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")


  OPEN(UNIT=102,FILE=TRIM(ENERGYfNAME),ACTION='READ',FORM='FORMATTED', &
  &    STATUS='OLD',ACCESS='SEQUENTIAL',POSITION='REWIND',IOSTAT=ferror)
  IF(ferror.NE.0) THEN
   PRINT*, "RUNTIME ERROR: CAN NOT FIND ("//TRIM(ENERGYfNAME)//") FOR THE ENERGY SPECTRUM DATA"
   RETURN
  END IF
  ferror=0

  fnLINES=0
  DO WHILE(EOFILE.EQV..FALSE.)
   READ(102,'(ES15.7)',IOSTAT=ferror) TEMPDBLE
   IF(ferror.LT.0) THEN
    EOFILE=.TRUE.
   ELSE
    fnLINES=fnLINES+1
   END IF
  END DO
  ferror=0
  REWIND(102,IOSTAT=ferror)
  IF(ALLOCATED(ENERGYDATA)) DEALLOCATE(ENERGYDATA)
  ALLOCATE(ENERGYDATA(fnLINES,Lnfld+2))
  ferror=0
  DO iCOUNTER=1,fnLINES
   READ(102,'(5ES15.7)',IOSTAT=ferror) ENERGYDATA(iCOUNTER,:)
   IF(ferror.NE.0) PRINT*, "ERROR IN READING DATA FROM "//TRIM(ENERGYfNAME)
  END DO
  CLOSE(102)

  GA(IPLOT)="plot"
  GA(SUPERTITLEfs)="8"
  GA(TITLEfs)="8"
  GA(XLABELfs)="8"
  GA(YLABELfs)="8"
! GA(LEGEND)="yes"
! GA(LEGENDPOS)="best"
! GA(XSCALE)="log"
  GA(YSCALE)="log"
  GA(XTICKSFMT)="%+.2e"

  GA(TITLE)="Electron Density Energy Spectrum"
  GA(XLABEL)="Time"
  GA(YLABEL)="$E_{n_k}$"
  CALL FORTPLOT(GFC,ENERGYDATA(:,1),ENERGYDATA(:,2),"ENERGYSPECTRUM",GA)

  GFC(PLTFIGNUM)=2
  GA(TITLE)="Electric Potential Energy Spectrum"
  GA(XLABEL)="Time"
  GA(YLABEL)="$E_{\phi_k}$"
  CALL FORTPLOT(GFC,ENERGYDATA(:,1),ENERGYDATA(:,3),"ENERGYSPECTRUM",GA)

  GFC(PLTFIGNUM)=3
  GA(TITLE)="Ion Velocity Potential Energy Spectrum"
  GA(XLABEL)="Time"
  GA(YLABEL)="$E_{\chi_k}$"
  CALL FORTPLOT(GFC,ENERGYDATA(:,1),ENERGYDATA(:,4),"ENERGYSPECTRUM",GA)

  GFC(PLTFIGNUM)=4
  GA(TITLE)="Total Energy Spectrum"
  GA(XLABEL)="Time"
  GA(YLABEL)="$E_{n_k+\phi_k+\chi_k}$"
  CALL FORTPLOT(GFC,ENERGYDATA(:,1),ENERGYDATA(:,5),"ENERGYSPECTRUM",GA)


  RETURN
 END SUBROUTINE PLOTENERGYSPECTRUM

 SUBROUTINE PLOTENERGY(LocX1D,LocY1D,LocGFC,LocGA)
  IMPLICIT NONE
  REAL(8)                :: LocX1D(:),LocY1D(:)
  INTEGER(4)             :: LocGID,LocFigNum,LocSFIGNUM,LocDTYPE,LocGFC(:)
  CHARACTER(*), OPTIONAL :: LocGA(:)
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)             :: GFC(10)
  CHARACTER*100          :: GA(100)="",GX(1)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=50
  GFC(PLTFIGNUM)=LocGFC(1)
  GFC(PLTSFIGNUM)=LocGFC(2)
  GFC(PLTFIGHOLD)=LocGFC(3)
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")

  GA(IPLOT)="plot"
! GA(YSCALE)="log"
  GA(SUPERTITLEfs)="8"
  GA(TITLEfs)="8"
  GA(XLABELfs)="8"
  GA(YLABELfs)="8"
! GA(LEGEND)="yes"
! GA(LEGENDPOS)="best"
  GA(XSCALE)="log"
  GA(YSCALE)="log"

  IF(PRESENT(LocGA)) THEN
   IF(SIZE(LocGA).GE.1) GA(SUPERTITLE)=TRIM(LocGA(1))
   IF(SIZE(LocGA).GE.2) GA(TITLE)=TRIM(LocGA(2))
   IF(SIZE(LocGA).GE.3) GA(XLABEL)=TRIM(LocGA(3))
   IF(SIZE(LocGA).GE.4) GA(YLABEL)=TRIM(LocGA(4))
!  IF(SIZE(LocGA).GE.5) GA(IPLOTLABEL)=TRIM(LocGA(5))
  END IF
  CALL FORTPLOT(GFC,LocX1D,LocY1D,"FLDENERGY",GA,GX)

  RETURN
 END SUBROUTINE PLOTENERGY


!******************************************************************************
!       PLOT ONE-DIMESNIONAL PROFILE OF SOME IONOPSHERIC PARAMETERS
!******************************************************************************
 SUBROUTINE r4r8PLOTPROFILE1D(LocX1D,Locf1D,LocGFC,LocGA)
  IMPLICIT NONE
  REAL(4)                :: LocX1D(:)
  REAL(8)                :: Locf1D(:)
  INTEGER(4)             :: LocGID,LocFigNum,LocSFIGNUM,LocGFC(:)
  CHARACTER(*), OPTIONAL :: LocGA(:)
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)             :: GFC(10)
  CHARACTER*100          :: GA(100)="",GX(1)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=200
  GFC(PLTFIGNUM)=LocGFC(1)
  GFC(PLTSFIGNUM)=LocGFC(2)
  GFC(PLTFIGHOLD)=LocGFC(3)
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("KEEP")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("REMOVE")
  GFC(PDFSAVE)=GETVALOF("SAVE")

! GA(XSCALE)="log"
! GA(SUPERTITLEfs)="8"
! GA(IPLOT)="loglog"
  GA(TITLEfs)="11"
  GA(XLABELfs)="10"
  GA(YLABELfs)="12"
  GA(XTICKSfs)="8"
  GA(YTICKSfs)="8"
 !GA(XLIMITS)="(0,25)"
 !GA(YLIMITS)="(-5,5)"

  IF(PRESENT(LocGA)) THEN
   IF(SIZE(LocGA).GE.1) GA(TITLE)=TRIM(LocGA(1))
   IF(SIZE(LocGA).GE.2) GA(XLABEL)=TRIM(LocGA(2))
   IF(SIZE(LocGA).GE.3) GA(YLABEL)=TRIM(LocGA(3))
   IF(SIZE(LocGA).GE.4) GA(LINEPROP)=TRIM(LocGA(4))
   IF(SIZE(LocGA).GE.5) THEN
    GA(IPLOTLABEL)=TRIM(LocGA(5))
    GA(LEGEND)="yes"
    GA(LEGENDPOS)="best"
   END IF
  END IF
  CALL FORTPLOT(GFC,1.0d0*LocX1D,Locf1D,"PPROFILE",GA,GX)

  RETURN
 END SUBROUTINE r4r8PLOTPROFILE1D

 SUBROUTINE r8r8PLOTPROFILE1D(LocX1D,Locf1D,LocGFC,LocGA)
  IMPLICIT NONE
  REAL(8)                :: LocX1D(:)
  REAL(8)                :: Locf1D(:)
  INTEGER(4)             :: LocGID,LocFigNum,LocSFIGNUM,LocGFC(:)
  CHARACTER(*), OPTIONAL :: LocGA(:)
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)             :: GFC(10)
  CHARACTER*100          :: GA(100)="",GX(1)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=200
  GFC(PLTFIGNUM)=LocGFC(1)
  GFC(PLTSFIGNUM)=LocGFC(2)
  GFC(PLTFIGHOLD)=LocGFC(3)
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")

! GA(XSCALE)="log"
! GA(SUPERTITLEfs)="8"
! GA(TITLEfs)="8"
  GA(XLABELfs)="8"
  GA(YLABELfs)="8"
  GA(LINEPROP)="k*"
! GA(LEGEND)="yes"
! GA(LEGENDPOS)="best"

  IF(PRESENT(LocGA)) THEN
   IF(SIZE(LocGA).GE.1) GA(SUPERTITLE)=TRIM(LocGA(1))
   IF(SIZE(LocGA).GE.2) GA(TITLE)=TRIM(LocGA(2))
   IF(SIZE(LocGA).GE.3) GA(XLABEL)=TRIM(LocGA(3))
   IF(SIZE(LocGA).GE.4) GA(YLABEL)=TRIM(LocGA(4))
   IF(SIZE(LocGA).GE.5) GA(IPLOTLABEL)=TRIM(LocGA(5))
  END IF
  CALL FORTPLOT(GFC,LocX1D,Locf1D,"PPROFILE",GA,GX)

  RETURN
 END SUBROUTINE r8r8PLOTPROFILE1D



!******************************************************************************
!       PLOT TWO-DIMESNIONAL PROFILE OF SOME IONOPSHERIC PARAMETERS
!******************************************************************************
 SUBROUTINE r4r8PLOTPROFILE2D(LocX2D,LocY2D,Locf2D,LocGFC,LocGA)
  IMPLICIT NONE
  REAL(4)                 :: LocX2D(:,:),LocY2D(:,:)
  REAL(8)                 :: Locf2D(:,:)
  INTEGER(4)              :: LocGID,LocFigNum,LocSFIGNUM,LocGFC(:)
  CHARACTER(25)           :: CBARLower,CBARUpper
  CHARACTER(*), OPTIONAL  :: LocGA(:)
  CHARACTER(10)           :: NUM2STR(10)=""
  REAL(4)                 :: CBARLowerVAL,CBARUpperVAL
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)              :: GFC(10)
  CHARACTER*100           :: GA(100)="",GX(3)=""

  PRINT*, "SYSGRAPHICS: IAM HERE!"

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=300
  GFC(PLTFIGNUM)=LocGFC(1)
  GFC(PLTSFIGNUM)=LocGFC(2)
  GFC(PLTFIGHOLD)=LocGFC(3)
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("KEEP")

! WRITE(NUM2STR(1),'(E7.1)') -MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))
! WRITE(NUM2STR(2),'(E7.1)') -MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/3.0)
! WRITE(NUM2STR(3),'(E7.1)') -MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/2.0)
! WRITE(NUM2STR(4),'(E7.1)') -MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/1.0)
! WRITE(NUM2STR(5),'(E7.1)') 0.0d0
! WRITE(NUM2STR(6),'(E7.1)')  MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/1.0)
! WRITE(NUM2STR(7),'(E7.1)')  MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/2.0)
! WRITE(NUM2STR(8),'(E7.1)')  MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))/(4.0/3.0)
! WRITE(NUM2STR(9),'(E7.1)')  MAX(ABS(MINVAL(Locf2D)),ABS(MAXVAL(Locf2D)))
! GA(CBARTICKS)="["//TRIM(NUM2STR(1))//","//TRIM(NUM2STR(2))//","//TRIM(NUM2STR(3))//","//TRIM(NUM2STR(4))//","//TRIM(NUM2STR(5))//","//TRIM(NUM2STR(6))//","//TRIM(NUM2STR(7))//","//TRIM(NUM2STR(8))//","//TRIM(NUM2STR(9))//"]"

  GA(IPLOT)="contourf"
 !GA(SUPERTITLE)="Density Pertubation"
 !GA(SUPERTITLE)="Phase Velocity of Particle Drifts"
 !GA(XLIMITS)="(-10,10)"
  IF(PRESENT(LocGA)) THEN
   IF((SIZE(LocGA).GE.1).AND.(LocGA(1).NE."")) THEN
    GA(TITLE)="Density Pertubation \n"//TRIM(LocGA(1))
   !GA(TITLEfs)="8"
   END IF
   IF((SIZE(LocGA).GE.2).AND.(LocGA(2).NE."")) GA(XLABEL)=TRIM(LocGA(2))
   IF((SIZE(LocGA).GE.3).AND.(LocGA(3).NE."")) GA(YLABEL)=TRIM(LocGA(3))
   IF((SIZE(LocGA).GE.4).AND.(LocGA(4).NE."")) THEN
    GA(CBAR) ="yes"
    GA(CBARTITLE)=TRIM(LocGA(4))
   END IF
  END IF
  CALL FORTPLOT(GFC,1.0d0*LocX2D,1.0d0*LocY2D,Locf2D,"PPROFILE",GA,GX)

  RETURN
 END SUBROUTINE r4r8PLOTPROFILE2D

 SUBROUTINE r8r8PLOTPROFILE2D(LocX2D,LocY2D,Locf2D,LocGFC,LocGA)
  IMPLICIT NONE
  REAL(8)                 :: LocX2D(:,:),LocY2D(:,:)
  REAL(8)                 :: Locf2D(:,:)
  INTEGER(4)              :: LocGID,LocFigNum,LocSFIGNUM,LocGFC(:)
  CHARACTER(25)           :: CBARLower,CBARUpper
  CHARACTER(*), OPTIONAL  :: LocGA(:)
  CHARACTER(10)           :: NUM2STR(5)=""
  REAL(4)                 :: CBARLowerVAL,CBARUpperVAL
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)              :: GFC(10)
  CHARACTER*100           :: GA(100)="",GX(3)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=200
  GFC(PLTFIGNUM)=LocGFC(1)
  GFC(PLTSFIGNUM)=LocGFC(2)
  GFC(PLTFIGHOLD)=LocGFC(3)
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(MOVNFPS)=GETVALOF("NO")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")

  WRITE(NUM2STR(1),'(E7.1)') MINVAL(Locf2D)
  WRITE(NUM2STR(2),'(E7.1)') (MAXVAL(Locf2D)+MINVAL(Locf2D))/2.0d0
  WRITE(NUM2STR(3),'(E7.1)') MAXVAL(Locf2D)
  GA(CBARTICKS)="["//TRIM(NUM2STR(1))//","//TRIM(NUM2STR(2))//","//TRIM(NUM2STR(3))//"]"

  GA(IPLOT)="contourf"
  GA(SUPERTITLE)="Energy Spectrum of Density Perturbation"
 !GA(SUPERTITLE)="Density Perturbation"
  GA(TITLEfs)="8"
  IF(PRESENT(LocGA)) THEN
   IF(SIZE(LocGA).GE.1) GA(TITLE)=TRIM(LocGA(1))
   IF(SIZE(LocGA).GE.2) GA(XLABEL)=TRIM(LocGA(2))
   IF(SIZE(LocGA).GE.3) GA(YLABEL)=TRIM(LocGA(3))
   IF(SIZE(LocGA).GE.4) THEN
    GA(CBAR) ="yes"
    GA(CBARTITLE)=TRIM(LocGA(4))
   END IF
   GX(1)="plt.tick_params(axis='x',which='both',bottom='off',top='off',labelbottom='off')"
   GA(XLIMITS)="(0,15)"
   GA(YLIMITS)="(-5,5)"

  END IF
  CALL FORTPLOT(GFC,LocX2D,LocY2D,Locf2D,"PPROFILE",GA,GX)

  RETURN
 END SUBROUTINE r8r8PLOTPROFILE2D


!******************************************************************************
!       PLOT THE LINEAR GROWTH RATE AND THE FREQUENCIES OF THE SYSTEM
!******************************************************************************
 SUBROUTINE PLOTEIGENS1D(PLTMODES,PLTSPACES,FIGUREHOLD,P1,P2,P3,P4,P5)
  USE SYSINFO
  USE SYSSOLVER
  USE FORTGRAPHER
  IMPLICIT NONE
  REAL(4), OPTIONAL, INTENT(IN) :: P1,P2,P3,P4,P5
  REAL(4), ALLOCATABLE          :: LocGAMMA1D(:),LocOMEGA1D(:)
  INTEGER(4)                    :: LOCALGID
  INTEGER(4)                    :: KxSFIGNUM,KySFIGNUM,KzSFIGNUM
  INTEGER(4)                    :: MATDIMS7D(7)
  INTEGER(4)                    :: LXDIM,LYDIM,LZDIM
  INTEGER(4)                    :: iXDIM,iYDIM,iZDIM
  INTEGER(4)                    :: lKxDIM,lKyDIM,lKzDIM
  INTEGER(4)                    :: iKxDIM,iKyDIM,iKzDIM
  INTEGER(4)                    :: KxMAX,KyMAX,KzMAX
  INTEGER(4)                    :: Lnfld
  INTEGER(4)                    :: PLTDIMS
  INTEGER(4)                    :: iPLTSPACE,iEIGENMODE
  INTEGER(4)                    :: ACCESSID=1
  LOGICAL                       :: KxDIR=.FALSE.
  LOGICAL                       :: KyDIR=.FALSE.
  LOGICAL                       :: KzDIR=.FALSE.
  LOGICAL                       :: XLOCAL,XQLOCAL,XNLOCAL
  LOGICAL                       :: YLOCAL,YQLOCAL,YNLOCAL
  LOGICAL                       :: ZLOCAL,ZQLOCAL,ZNLOCAL
  CHARACTER(*),      INTENT(IN) :: PLTSPACES,PLTMODES
  CHARACTER(*),      INTENT(IN) :: FIGUREHOLD
  CHARACTER*2                   :: NTEXT1,NTEXT2,NTEXT3
  CHARACTER*10                  :: RTEXT1,RTEXT2,RTEXT3
  CHARACTER*20                  :: DTEXT1,DTEXT2,DTEXT3
  CHARACTER*20                  :: D1TEXT,D2TEXT,D3TEXT
  CHARACTER*10                  :: p1TEXT,P2TEXT,p3TEXT,p4TEXT,p5TEXT
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)    :: GFC(10)
  CHARACTER*200 :: GA(100)=""
  CHARACTER*150 :: GX(1)=""

  IF((FIGUREHOLD.EQ."FIGHOLD").OR.(FIGUREHOLD.EQ."fighold")) THEN
   LOCALGID=1
  ELSE IF((FIGUREHOLD.EQ."FIGNOHOLD").OR.(FIGUREHOLD.EQ."fignohold")) THEN
   LOCALGID=0
  END IF

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=50
  GFC(PLTFIGNUM)=1
  GFC(PLTSFIGNUM)=111
  GFC(PLTFIGHOLD)=GETVALOF("NO")
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")
  GFC(MOVNFPS)=GETVALOF("NO")

  MATDIMS7D=SHAPE(EIGENVAL7D)
  LXDIM=MATDIMS7D(1);LYDIM=MATDIMS7D(2);LZDIM=MATDIMS7D(3)
  LKxDIM=MATDIMS7D(4);LKyDIM=MATDIMS7D(5);LKzDIM=MATDIMS7D(6)
  Lnfld=MATDIMS7D(7)

  IF(LXDIM.EQ.1) THEN
   XLOCAL=.TRUE.
   XNLOCAL=.FALSE.
   XQLOCAL=.FALSE.
  ELSE IF(LXDIM.EQ.XDIM) THEN
   XLOCAL=.FALSE.
   XNLOCAL=.TRUE.
   XQLOCAL=.FALSE.
  ELSE IF((LXDIM.GT.1).AND.(LXDIM.LT.XDIM)) THEN
   XLOCAL=.FALSE.
   XNLOCAL=.FALSE.
   XQLOCAL=.TRUE.
  END IF

  IF(LYDIM.EQ.1) THEN
   YLOCAL=.TRUE.
   YNLOCAL=.FALSE.
   YQLOCAL=.FALSE.
  ELSE IF(LYDIM.EQ.YDIM) THEN
   YLOCAL=.FALSE.
   YNLOCAL=.TRUE.
   YQLOCAL=.FALSE.
  ELSE IF((LYDIM.GT.1).AND.(LYDIM.LT.YDIM)) THEN
   YLOCAL=.FALSE.
   YNLOCAL=.FALSE.
   YQLOCAL=.TRUE.
  END IF

  IF(LZDIM.EQ.1) THEN
   ZLOCAL=.TRUE.
   ZNLOCAL=.FALSE.
   ZQLOCAL=.FALSE.
  ELSE IF(LZDIM.EQ.ZDIM) THEN
   ZLOCAL=.FALSE.
   ZNLOCAL=.TRUE.
   ZQLOCAL=.FALSE.
  ELSE IF((LZDIM.GT.1).AND.(LZDIM.LT.ZDIM)) THEN
   ZLOCAL=.FALSE.
   ZNLOCAL=.FALSE.
   ZQLOCAL=.TRUE.
  END IF

  IF(PRESENT(P1)) THEN; WRITE(p1TEXT,'(F7.1)') P1; ELSE; p1TEXT=""; END IF
  IF(PRESENT(P2)) THEN; WRITE(p2TEXT,'(F7.1)') P2; ELSE; p2TEXT=""; END IF
  IF(PRESENT(P3)) THEN; WRITE(p3TEXT,'(F3.1)') P3; ELSE; p3TEXT=""; END IF
  IF(PRESENT(P4)) THEN; WRITE(p4TEXT,'(F3.1)') P4; ELSE; p4TEXT=""; END IF
  IF(PRESENT(P5)) THEN; WRITE(p5TEXT,'(F5.1)') P5; ELSE; p5TEXT=""; END IF

  GA(TITLEfs)="9"
  GA(SUPERTITLEfs)="10"
  IF(ACCESSID.EQ.1) THEN
   GA(IPLOTLABEL)="Standard Model"
   GA(LINEPROP)="g--"
   ACCESSID=ACCESSID+1
  ELSE IF(ACCESSID.EQ.2) THEN
   GA(IPLOTLABEL)="Ion Viscosity"
   GA(LINEPROP)="r--"
   ACCESSID=ACCESSID+1
  ELSE IF(ACCESSID.EQ.3) THEN
   GA(IPLOTLABEL)="Electron Inertia"
   GA(LINEPROP)="b--"
   ACCESSID=ACCESSID+1
  ELSE IF(ACCESSID.EQ.4) THEN
   GA(IPLOTLABEL)="Unified Model"
   GA(LINEPROP)="k"
   ACCESSID=ACCESSID+1
  END IF
 !GA(IPLOTLABEL)="$\\upsilon_E$= "//TRIM(p1TEXT)//" (m/s)"
!!GA(IPLOTLABEL)="$L_{yn_e}$= "//TRIM(p2TEXT)//" (m)"
  GA(LEGEND)="yes"
  GA(LEGENDPOS)="best"
  GA(LEGENDfs)="8"
 !GA(GRID)="no"
! GA(XSCALE)="log"
! GA(YSCALE)="log"
! GA(LINEPROP)="*"
! IF(ACCESSID.GT.7) GA(LINEPROP)="--"

  KxMAX=KxGMAX3D(1,1,1);KyMAX=KyGMAX3D(1,1,1);KzMAX=KzGMAX3D(1,1,1)
  IF((PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN 
   lKxDIM=1;lKyDIM=1;lKzDIM=1
   iXDIM=1;iYDIM=1;iZDIM=1
   DO iKxDIM=1,SIZE(eiKx1D)
    IF(AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,iKxDIM,KyMAX,KzMAX,1)).GT.0.0) lKxDIM=lKxDIM+1
   END DO
   DO iKyDIM=1,SIZE(eiKy1D)
    IF(AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,iKyDIM,KzMAX,1)).GT.0.0) lKyDIM=lKyDIM+1
   END DO
   DO iKzDIM=1,SIZE(eiKz1D)
    IF(AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,KyMAX,iKzDIM,1)).GT.0.0) lKzDIM=lKzDIM+1
   END DO
  END IF

  DO iPLTSPACE=1,LEN(PLTSPACES)
   KxDIR=.FALSE.
   KyDIR=.FALSE.
   KzDIR=.FALSE.
   IF(ALLOCATED(LocGAMMA1D)) DEALLOCATE(LocGAMMA1D)
   IF(ALLOCATED(LocOMEGA1D)) DEALLOCATE(LocOMEGA1D)
   IF((PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."x").OR.(PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."X")) THEN
    KxDIR=.TRUE.
    IF(SIZE(eiKx1D).NE.1) THEN
     IF(ALLOCATED(LocGAMMA1D).EQV..FALSE.) ALLOCATE(LocGAMMA1D(lKxDIM))
     IF(ALLOCATED(LocOMEGA1D).EQV..FALSE.) ALLOCATE(LocOMEGA1D(lKxDIM))
     GA(XLABEL)="$k_x$ $(m^{-1})$"
     IF(LEN(PLTSPACES).EQ.1) THEN
      KxSFIGNUM=111
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.1)) THEN
      KxSFIGNUM=121
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.2)) THEN
      KxSFIGNUM=122
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.1)) THEN
      KxSFIGNUM=131
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.2)) THEN
      KxSFIGNUM=132
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.3)) THEN
      KxSFIGNUM=133
     END IF
    END IF
   ELSE IF((PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."y").OR.(PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."Y")) THEN
    KyDIR=.TRUE.
    IF(SIZE(eiKy1D).NE.1) THEN
     IF(ALLOCATED(LocGAMMA1D).EQV..FALSE.) ALLOCATE(LocGAMMA1D(lKyDIM))
     IF(ALLOCATED(LocOMEGA1D).EQV..FALSE.) ALLOCATE(LocOMEGA1D(lKyDIM))
     GA(XLABEL)="$k_y$ $(m^{-1})$"
     IF(LEN(PLTSPACES).EQ.1) THEN
      KySFIGNUM=111
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.1)) THEN
      KySFIGNUM=121
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.2)) THEN
      KySFIGNUM=122
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.1)) THEN
      KySFIGNUM=131
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.2)) THEN
      KySFIGNUM=132
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.3)) THEN
      KySFIGNUM=133
     END IF
    END IF
   ELSE IF((PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."z").OR.(PLTSPACES(iPLTSPACE:iPLTSPACE).EQ."Z")) THEN
    KzDIR=.TRUE.
    IF(SIZE(eiKz1D).NE.1) THEN
     IF(ALLOCATED(LocGAMMA1D).EQV..FALSE.) ALLOCATE(LocGAMMA1D(lKzDIM))
     IF(ALLOCATED(LocOMEGA1D).EQV..FALSE.) ALLOCATE(LocOMEGA1D(lKzDIM))
     GA(XLABEL)="$k_z$ $(m^{-1})$"
     IF(LEN(PLTSPACES).EQ.1) THEN
      KzSFIGNUM=111
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.1)) THEN
      KzSFIGNUM=121
     ELSE IF((LEN(PLTSPACES).EQ.2).AND.(iPLTSPACE.EQ.2)) THEN
      KzSFIGNUM=122
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.1)) THEN
      KzSFIGNUM=131
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.2)) THEN
      KzSFIGNUM=132
     ELSE IF((LEN(PLTSPACES).EQ.3).AND.(iPLTSPACE.EQ.3)) THEN
      KzSFIGNUM=133
     END IF
    END IF
   END IF

   IF(XNLOCAL.AND.(YNLOCAL.AND.ZNLOCAL)) THEN
    DO iXDIM=1,LXDIM
     DO iYDIM=1,LYDIM
      DO iZDIM=1,LZDIM
       WRITE(D1TEXT,'(F9.5)') LAT1D(iXDIM)
       WRITE(D2TEXT,'(F9.5)') LON1D(iYDIM)
       WRITE(D3TEXT,'(F9.5)') ALT1D(iZDIM)
       KxMAX=KxGMAX3D(iXDIM,iYDIM,iZDIM)
       KyMAX=KyGMAX3D(iXDIM,iYDIM,iZDIM)
       KzMAX=KzGMAX3D(iXDIM,iYDIM,iZDIM)
       WRITE(RTEXT1,'(F8.5)') eiKx1D(KxMAX)
       WRITE(RTEXT2,'(F8.5)') eiKy1D(KyMAX)
       WRITE(RTEXT3,'(F8.5)') eiKz1D(KzMAX)
       GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m,\upsilon_E="//TRIM(p1TEXT)//" (m/s)$"
       IF(KxDIR) THEN
        GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
        GFC(PLTSFIGNUM)=KxSFIGNUM
        IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
         DO iEIGENMODE=1,Lnfld
          IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
           GFC(PLTFIGHOLD)=LOCALGID
          ELSE
           GFC(PLTFIGHOLD)=GETVALOF("YES")
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,:,KyMAX,KzMAX,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAKx1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,:,KyMAX,KzMAX,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAKx1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
          END IF
         END DO
        ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
         IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
          GFC(PLTFIGHOLD)=GETVALOF("YES")
         ELSE
          GFC(PLTFIGHOLD)=LOCALGID
         END IF
        !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
         GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
         IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
          GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
         ELSE
          GA(YLABEL)=""
         END IF
         LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,1:lKxDIM,KyMAX,KzMAX,1))
         IF(LEN(PLTSPACES).EQ.1) THEN
          CALL FORTPLOT(GFC,eiKx1D(1:lKxDIM),LocOMEGA1D,"OMEGAKx1D",GA,GX)
         ELSE
          CALL FORTPLOT(GFC,eiKx1D(1:lKxDIM),LocOMEGA1D,"OMEGAK1D",GA,GX)
         END IF
        !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
         GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
         IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
          GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
         ELSE
          GA(YLABEL)=""
         END IF
         LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,1:lKxDIM,KyMAX,KzMAX,1))
         IF(LEN(PLTSPACES).EQ.1) THEN
          CALL FORTPLOT(GFC,eiKx1D(1:lKxDIM),LocGAMMA1D,"GAMMAKx1D",GA,GX)
         ELSE
          CALL FORTPLOT(GFC,eiKx1D(1:lKxDIM),LocGAMMA1D,"GAMMAK1D",GA,GX)
         END IF
        END IF
       ELSE IF(KyDIR) THEN
        GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
        GFC(PLTSFIGNUM)=KySFIGNUM
        IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
         DO iEIGENMODE=1,Lnfld
          IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
           GFC(PLTFIGHOLD)=LOCALGID
          ELSE
           GFC(PLTFIGHOLD)=GETVALOF("YES")
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,:,KzMAX,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKy1D,LocOMEGA1D,"OMEGAKy1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKy1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,:,KzMAX,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKy1D,LocGAMMA1D,"GAMMAKy1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKy1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
          END IF
         END DO
        ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
          IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
           GFC(PLTFIGHOLD)=GETVALOF("YES")
          ELSE
           GFC(PLTFIGHOLD)=LOCALGID
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,1:lKyDIM,KzMAX,1))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocOMEGA1D,"OMEGAKy1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocOMEGA1D,"OMEGAK1D",GA,GX)
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,1:lKyDIM,KzMAX,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocGAMMA1D,"GAMMAKy1D",GA,GX)
          ELSE
          !GA(YLIMITS)="(-10.0,10.0)"
           CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocGAMMA1D,"GAMMAK1D",GA,GX)
           GA(YLIMITS)=""
          END IF
        END IF
       ELSE IF(KzDIR) THEN
        GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
        GFC(PLTSFIGNUM)=KzSFIGNUM
        IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
         DO iEIGENMODE=1,Lnfld
          IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
           GFC(PLTFIGHOLD)=LOCALGID
          ELSE
           GFC(PLTFIGHOLD)=1
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF 
          LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,KyMAX,:,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKz1D,LocOMEGA1D,"OMEGAKz1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKz1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,KyMAX,:,iEIGENMODE))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKz1D,LocGAMMA1D,"GAMMAKz1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKz1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
          END IF
         END DO
        ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
          IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
           GFC(PLTFIGHOLD)=GETVALOF("YES")
          ELSE
           GFC(PLTFIGHOLD)=LOCALGID
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocOMEGA1D=REAL(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,KyMAX,1:lKzDIM,1))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocOMEGA1D,"OMEGAKz1D",GA,GX)
          ELSE
           CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocOMEGA1D,"OMEGAK1D",GA,GX)
          END IF
         !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
          GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
          IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
           GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
          ELSE
           GA(YLABEL)=""
          END IF
          LocGAMMA1D=AIMAG(EIGENVAL7D(iXDIM,iYDIM,iZDIM,KxMAX,KyMAX,1:lKzDIM,1))
          IF(LEN(PLTSPACES).EQ.1) THEN
           CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocGAMMA1D,"GAMMAKz1D",GA,GX)
          ELSE
          !GA(YLIMITS)="(-10.0,10.0)"
           CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocGAMMA1D,"GAMMAK1D",GA,GX)
           GA(YLIMITS)=""
          END IF
        END IF
       END IF
      END DO
     END DO
    END DO
   ELSE IF(XLOCAL.AND.(YLOCAL.AND.ZLOCAL)) THEN
      !GA(YLIMITS)="(0.0,300.0)"
      !GA(XLIMITS)="(0.0,25.0)"
    iXDIM=XDIM/2+1
    iYDIM=YDIM/2+1
    iZDIM=ZDIM/2+1
    WRITE(D1TEXT,'(F9.5)') LAT1D(iXDIM)
    WRITE(D2TEXT,'(F9.5)') LON1D(iYDIM)
    WRITE(D3TEXT,'(F9.5)') ALT1D(iZDIM)
    KxMAX=KxGMAX3D(1,1,1)
    KyMAX=KyGMAX3D(1,1,1)
    KzMAX=KzGMAX3D(1,1,1)
    WRITE(RTEXT1,'(F8.5)') eiKx1D(KxMAX)
    WRITE(RTEXT2,'(F8.5)') eiKy1D(KyMAX)
    WRITE(RTEXT3,'(F8.5)') eiKz1D(KzMAX)
    GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m,\upsilon_E="//TRIM(p1TEXT)//" (m/s)$"
    IF(KxDIR) THEN
     GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
     GFC(PLTSFIGNUM)=KxSFIGNUM
     IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
      DO iEIGENMODE=1,Lnfld
       IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
        GFC(PLTFIGHOLD)=LOCALGID
       ELSE
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,:,KyMAX,KzMAX,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAKx1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,:,KyMAX,KzMAX,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAKx1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
      END DO
     ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
       IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       ELSE
        GFC(PLTFIGHOLD)=LOCALGID
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,:,KyMAX,KzMAX,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAKx1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKx1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KxSFIGNUM.EQ.111).OR.(KxSFIGNUM.EQ.121).OR.(KxSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,:,KyMAX,KzMAX,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAKx1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKx1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
     END IF
    ELSE IF(KyDIR) THEN
     GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
     GFC(PLTSFIGNUM)=KySFIGNUM
     IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
      DO iEIGENMODE=1,Lnfld
       IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
        GFC(PLTFIGHOLD)=LOCALGID
       ELSE
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,KxMAX,:,KzMAX,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKy1D,LocOMEGA1D,"OMEGAKy1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKy1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,KxMAX,:,KzMAX,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKy1D,LocGAMMA1D,"GAMMAKy1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKy1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
      END DO
     ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
       IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       ELSE
        GFC(PLTFIGHOLD)=LOCALGID
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,KxMAX,1:lKyDIM,KzMAX,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocOMEGA1D,"OMEGAKy1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KySFIGNUM.EQ.111).OR.(KySFIGNUM.EQ.121).OR.(KySFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,KxMAX,1:lKyDIM,KzMAX,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocGAMMA1D,"GAMMAKy1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKy1D(1:lKyDIM),LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
     END IF
    ELSE IF(KzDIR) THEN
     GFC(PLTFIGNUM)=1000*iXDIM+100*iYDIM+10*iZDIM
     GFC(PLTSFIGNUM)=KzSFIGNUM
     IF((PLTMODES.EQ."all").OR.(PLTMODES.EQ."ALL")) THEN
      DO iEIGENMODE=1,Lnfld
       IF((iPLTSPACE.EQ.LEN(PLTSPACES)).AND.(iEIGENMODE.EQ.Lnfld)) THEN
        GFC(PLTFIGHOLD)=LOCALGID
       ELSE
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,KxMAX,KyMAX,:,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKz1D,LocOMEGA1D,"OMEGAKz1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKz1D,LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,KxMAX,KyMAX,:,iEIGENMODE))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKz1D,LocGAMMA1D,"GAMMAKz1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKz1D,LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
      END DO
     ELSE IF((PLTMODES.EQ."max").OR.(PLTMODES.EQ."MAX").OR.(PLTMODES.EQ."max-positive").OR.(PLTMODES.EQ."MAX-POSITIVE")) THEN
       IF(iPLTSPACE.NE.LEN(PLTSPACES)) THEN
        GFC(PLTFIGHOLD)=GETVALOF("YES")
       ELSE
        GFC(PLTFIGHOLD)=LOCALGID
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\omega_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\omega_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocOMEGA1D=REAL(EIGENVAL7D(1,1,1,KxMAX,KyMAX,1:lKzDIM,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocOMEGA1D,"OMEGAKz1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocOMEGA1D,"OMEGAK1D",GA,GX)
       END IF
      !GA(TITLE)="$k_x="//TRIM(RTEXT1)//" m^{-1},k_y="//TRIM(RTEXT2)//" m^{-1},k_z="//TRIM(RTEXT3)//" m^{-1},L_n="//TRIM(p2TEXT)//" m$"
       GA(SUPERTITLE)="$\\gamma_k(k_x,k_y,k_z,LAT="//TRIM(D1TEXT)//",LON="//TRIM(D2TEXT)//",ALT="//TRIM(D3TEXT)//")$"
       IF((KzSFIGNUM.EQ.111).OR.(KzSFIGNUM.EQ.121).OR.(KzSFIGNUM.EQ.131)) THEN
        GA(YLABEL)="$\\gamma_k$ $(s^{-1})$"
       ELSE
        GA(YLABEL)=""
       END IF
       LocGAMMA1D=AIMAG(EIGENVAL7D(1,1,1,KxMAX,KyMAX,1:lKzDIM,1))
       IF(LEN(PLTSPACES).EQ.1) THEN
        CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocGAMMA1D,"GAMMAKz1D",GA,GX)
       ELSE
        CALL FORTPLOT(GFC,eiKz1D(1:lKzDIM),LocGAMMA1D,"GAMMAK1D",GA,GX)
       END IF
     END IF
    END IF
   END IF
  END DO

  RETURN
 END SUBROUTINE PLOTEIGENS1D


 SUBROUTINE PLOTEIGENS2D(LocKx1D,LocKy1D,LocKz1D,LocEIGENVAL2D,LOCALGFC,P1,P2,P3,P4,P5)
  IMPLICIT NONE
  REAL(4),OPTIONAL      :: P1,P2,P3,P4,P5
  REAL(4)               :: LocKx1D(:),LocKy1D(:),LocKz1D(:)
  REAL(4),ALLOCATABLE   :: LocGAMMA2D(:,:),LocOMEGA2D(:,:)
  REAL(4),ALLOCATABLE   :: LocKx2D(:,:),LocKy2D(:,:),LocKz2D(:,:)
  COMPLEX(4)            :: LocEIGENVAL2D(:,:)
  INTEGER(4)            :: LocalGFC(3)
  INTEGER(4)            :: PLTDIMS(2)
  CHARACTER*2           :: NTEXT1,NTEXT2,NTEXT3
  CHARACTER*10          :: RTEXT1,RTEXT2,RTEXT3
  CHARACTER*20          :: DTEXT1,DTEXT2,DTEXT3
  CHARACTER*10          :: p1TEXT,P2TEXT,p3TEXT,p4TEXT,p5TEXT
!************** GRAPHICS CHARACTERISTIC MATRICES ******************
  INTEGER(4)    :: GFC(10)
  CHARACTER*100 :: GA(100)="",GX(1)=""

!******** GFC INITIALIZATION ************
  GFC(PLTDPI)=50
  GFC(PLTFIGNUM)=LocalGFC(1)
  GFC(PLTSFIGNUM)=111
  GFC(PLTFIGHOLD)=GETVALOF("NO")
  GFC(PLTYYAXES)=GETVALOF("NO")
  GFC(DATTYPE)=GETVALOF("FORMATTED")
  GFC(DATSAVE)=GETVALOF("REMOVE")
  GFC(PNGSAVE)=GETVALOF("DELETE")
  GFC(PDFSAVE)=GETVALOF("SAVE")
  GFC(MOVNFPS)=GETVALOF("NO")

  PLTDIMS=SHAPE(LocEIGENVAL2D)
  IF(ALLOCATED(LocGAMMA2D)) DEALLOCATE(LocGAMMA2D)
  ALLOCATE(LocGAMMA2D(PLTDIMS(1),PLTDIMS(2)))
  IF(ALLOCATED(LocOMEGA2D)) DEALLOCATE(LocOMEGA2D)
  ALLOCATE(LocOMEGA2D(PLTDIMS(1),PLTDIMS(2)))


  IF(PRESENT(P1)) THEN; WRITE(p1TEXT,'(F7.1)') P1; ELSE; p1TEXT=""; END IF
  IF(PRESENT(P2)) THEN; WRITE(p2TEXT,'(F7.1)') P2; ELSE; p2TEXT=""; END IF
  IF(PRESENT(P3)) THEN; WRITE(p3TEXT,'(F7.1)') P3; ELSE; p3TEXT=""; END IF
  IF(PRESENT(P4)) THEN; WRITE(p4TEXT,'(F7.1)') P4; ELSE; p4TEXT=""; END IF
  IF(PRESENT(P5)) THEN; WRITE(p5TEXT,'(F7.1)') P5; ELSE; p5TEXT=""; END IF

  IF(SIZE(LocKy1D).EQ.1) THEN
    WRITE(RTEXT2,'(F3.1)') LocKy1D(1)
    IF(ALLOCATED(LocKx2D)) DEALLOCATE(LocKx2D)
    ALLOCATE(LocKx2D(PLTDIMS(1),PLTDIMS(2)))
    IF(ALLOCATED(LocKz2D)) DEALLOCATE(LocKz2D)
    ALLOCATE(LocKz2D(PLTDIMS(1),PLTDIMS(2)))
    CALL MESHGRID(LocKx1D,LocKz1D,LocKx2D,LocKz2d)
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    WRITE(RTEXT1,'(F3.1)') LocKx1D(1)
    IF(ALLOCATED(LocKy2D)) DEALLOCATE(LocKy2D)
    ALLOCATE(LocKy2D(PLTDIMS(1),PLTDIMS(2)))
    IF(ALLOCATED(LocKz2D)) DEALLOCATE(LocKz2D)
    ALLOCATE(LocKz2D(PLTDIMS(1),PLTDIMS(2)))
    CALL MESHGRID(LocKy1D,LocKz1D,LocKy2D,LocKz2d)
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    WRITE(RTEXT3,'(F3.1)') LocKz1D(1)
    IF(ALLOCATED(LocKx2D)) DEALLOCATE(LocKx2D)
    ALLOCATE(LocKx2D(PLTDIMS(1),PLTDIMS(2)))
    IF(ALLOCATED(LocKy2D)) DEALLOCATE(LocKy2D)
    ALLOCATE(LocKy2D(PLTDIMS(1),PLTDIMS(2)))
    CALL MESHGRID(LocKx1D,LocKy1D,LocKx2D,LocKy2d)
  END IF

  GA(SUPERTITLE)="Goegraphic Coordinates: (LAT="//TRIM(p3TEXT)//",LON="//TRIM(p4TEXT)//",ALT="//TRIM(p5TEXT)//")"
  GA(SUPERTITLEfs)="10"
  GA(GRID)="yes"

  LocOMEGA2D=REAL(LocEIGENVAL2D)
  GFC(PLTFIGHOLD)=GETVALOF("YES")
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(TITLE)="$\\omega_r(k_x,k_y="//TRIM(RTEXT2)//" (m^{-1}),k_z,\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(TITLE)="$\\omega_r(k_x="//TRIM(RTEXT1)//"(m^{-1}),k_y,k_z,\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(TITLE)="$\\omega_r(k_x,k_y,k_z="//TRIM(RTEXT3)//"(m^{-1}),\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  END IF
  GA(SUPERTITLEfs)="9"
  GA(LINEPROP)="k"
  GA(CBAR)=""
  GA(CBARTITLE)=""
  GA(IPLOT)="contour"
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKz2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(XLABEL)="$k_y$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKy2D,LocKz2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_y$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKy2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  END IF
  GFC(PLTFIGHOLD)=GETVALOF("NO")
  GA(LINEPROP)=""
  GA(CBAR)="yes"
  GA(CBARTITLE)="$\omega_r$ ($s^{-1}$)"
  GA(IPLOT)="contourf"
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKz2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(XLABEL)="$k_y$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKy2D,LocKz2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_y$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKy2D,LocOMEGA2D,"LinearOMEGA2D",GA,GX)
  END IF

  LocGAMMA2D=AIMAG(LocEIGENVAL2D)
  GFC(PLTFIGHOLD)=GETVALOF("YES")
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(TITLE)="$\\gamma(k_x,k_y="//TRIM(RTEXT2)//" (m^{-1}),k_z,\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(TITLE)="$\\gamma(k_x="//TRIM(RTEXT1)//"(m^{-1}),k_y,k_z,\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(TITLE)="$\\gamma(k_x,k_y,k_z="//TRIM(RTEXT3)//"(m^{-1}),\\upsilon_E="//TRIM(p1TEXT)//" m/s,L_n="//TRIM(p2TEXT)//" m)$"
  END IF
  GA(SUPERTITLEfs)="8"
  GA(LINEPROP)="k"
  GA(CBAR)=""
  GA(CBARTITLE)=""
  GA(IPLOT)="contour"
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKz2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(XLABEL)="$k_y$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKy2D,LocKz2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_y$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKy2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  END IF
  GFC(PLTFIGHOLD)=GETVALOF("NO")
  GA(LINEPROP)=""
  GA(CBAR)="yes"
  GA(CBARTITLE)="$\gamma$ ($s^{-1}$)"
  GA(IPLOT)="contourf"
  IF(SIZE(LocKy1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKz2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  ELSE IF(SIZE(LocKx1D).EQ.1) THEN
    GA(XLABEL)="$k_y$ $(m^{-1})$"
    GA(YLABEL)="$k_z$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKy2D,LocKz2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  ELSE IF(SIZE(LocKz1D).EQ.1) THEN
    GA(XLABEL)="$k_x$ $(m^{-1})$"
    GA(YLABEL)="$k_y$ $(m^{-1})$"
    CALL FORTPLOT(GFC,LocKx2D,LocKy2D,LocGAMMA2D,"LinearGAMMA2D",GA,GX)
  END IF

  RETURN
 END SUBROUTINE PLOTEIGENS2D


!******************************************************************************
!                PLOT THE FIELDS IN THE R-SPACE and K-SPACE
!******************************************************************************
 SUBROUTINE r4FieldsPlotNETCDF(PLTSPACES,LX3D,LY3D,LZ3D,NETCDFFNAME,FLDSNAME,DIMSNAME,rplotType,kplotType)
  USE IONOBG
  USE RDSVNETCDF
  IMPLICIT NONE
!*************** INPUT VARIABLES DECLARATION *******************
  REAL(4),     INTENT(INOUT)        :: LX3D(:,:,:),LY3D(:,:,:),LZ3D(:,:,:)
  CHARACTER(*),INTENT(IN)           :: PLTSPACES
  CHARACTER(*),INTENT(IN)           :: NETCDFFNAME
  CHARACTER(*),INTENT(INOUT)        :: FLDSNAME(:)
  CHARACTER(*),INTENT(INOUT)        :: DIMSNAME(:)
  CHARACTER(*),INTENT(IN),OPTIONAL  :: rplotType,kplotType
!************** LOCAL VARIABLES DECLARATION ********************
  REAL(8),     ALLOCATABLE          ::    rfld(:,:,:,:)
  REAL(4),     ALLOCATABLE          ::    sDim(:,:),    tDIM(:,:)
  REAL(4),     ALLOCATABLE          ::  exsDim(:,:),  extDIM(:,:)
  REAL(4),     ALLOCATABLE          ::    rNyt(:,:),    rNzt(:,:)
  REAL(4),     ALLOCATABLE          ::  exrNyt(:,:),  exrNzt(:,:)
  REAL(8),     ALLOCATABLE          ::    rEy(:,:,:),   rEz(:,:,:)
  REAL(8),     ALLOCATABLE          ::   rVey(:,:,:),  rVez(:,:,:)
  REAL(8),     ALLOCATABLE          ::   rViy(:,:,:),  rViz(:,:,:)
  REAL(8),     ALLOCATABLE          :: rFnvey(:,:,:),rFnvez(:,:,:)
  REAL(8),     ALLOCATABLE          :: efldKy(:,:,:),efldKz(:,:,:)
  REAL(8),     ALLOCATABLE          :: efldKyAVG(:,:),efldKzAVG(:,:)
  REAL(8),     ALLOCATABLE          :: rFnviy(:,:,:),rFnviz(:,:,:)
  REAL(8),     ALLOCATABLE          :: rEyAVG(:),rEzAVG(:)
  REAL(8),     ALLOCATABLE          :: rEySTD(:),rEzSTD(:)
  REAL(8),     ALLOCATABLE          :: rEyPSTD(:),rEzPSTD(:)
  REAL(8),     ALLOCATABLE          :: rEyNSTD(:),rEzNSTD(:)
  REAL(8),     ALLOCATABLE          :: rEytAVG(:,:),rEztAVG(:,:)
  REAL(4),     ALLOCATABLE          :: rNLSRT(:)
  REAL(8),     ALLOCATABLE          :: rNeSTD(:,:)
  REAL(8),     ALLOCATABLE          :: rVeyAVG(:),rVezAVG(:)
  REAL(8),     ALLOCATABLE          :: rViyAVG(:),rVizAVG(:)
  REAL(8),     ALLOCATABLE          :: rnVeyAVG(:),rnVezAVG(:)
  REAL(8),     ALLOCATABLE          :: kNeSTD(:)
  REAL(8),     ALLOCATABLE          :: rwNe(:)
  REAL(8),     ALLOCATABLE          :: kTIME(:)
  REAL(4),     ALLOCATABLE          :: rTIME(:)
  REAL(8)                           :: rwNEMAXVAL
  REAL(4)                           :: SLOP,XX(13),YY(13)
  REAL(4)                           :: RUNTIME
  COMPLEX(8),  ALLOCATABLE          ::   kfld(:,:,:,:)
  COMPLEX(8),  ALLOCATABLE          :: exkfld(:,:),exiKy2D(:,:),exiKz2D(:,:)
  COMPLEX(8),  ALLOCATABLE          ::    kEy(:,:,:),   kEz(:,:,:)
  COMPLEX(8),  ALLOCATABLE          ::   kVey(:,:,:),  kVez(:,:,:)
  COMPLEX(8),  ALLOCATABLE          ::   kViy(:,:,:),  kViz(:,:,:)
  COMPLEX(8),  ALLOCATABLE          :: kFnvey(:,:,:),kFnvez(:,:,:)
  COMPLEX(8),  ALLOCATABLE          :: kFnviy(:,:,:),kFnviz(:,:,:)
  COMPLEX(8),  ALLOCATABLE          :: kwNe(:),kwNeSTD(:)
  INTEGER(4)                        :: nPrEy,nNrEy
  INTEGER(4)                        :: nPrEz,nNrEz
  INTEGER(4)                        :: nDIMS,nVARS,nREC
  INTEGER(4)                        :: D1MAT13,D2MAT13,D3MAT13
  INTEGER(4)                        :: MATDIMS4D(4)
  INTEGER(4)                        :: iREC
  INTEGER(4)                        :: iTREC=0
  INTEGER(4)                        :: ifld,nflds
  INTEGER(4)                        :: D1MAT23,D2MAT23,D3MAT23
  INTEGER(4)                        :: D1MAT12,D2MAT12,D3MAT12
  INTEGER(4)                        :: iD1,iD2,iD3
  INTEGER(4)                        :: iKxMAX,iKyMAX,iKzMAX
  INTEGER(4)                        :: LXDIM,LYDIM,LZDIM
  INTEGER(4)                        :: NeMAXLOC2D(2)
  INTEGER(4)                        :: iDIM1,iDIM2,ferror
  CHARACTER(25)                     :: FLDSUNIT(3)
  CHARACTER(25)                     :: DIMSUNIT(4)
  CHARACTER(10)                     :: NUMSTR


  CALL NETCDF_INFO(TRIM(NETCDFFNAME),nDIMS,nVARS)
  CALL NETCDF_VAR_DIMS(TRIM(NETCDFFNAME),TRIM(FLDSNAME(1)),MATDIMS4D)
  nflds=nVARS-nDIMS
  nREC=MATDIMS4D(4)
  LXDIM=MATDIMS4D(1)
  LYDIM=MATDIMS4D(2)
  LZDIM=MATDIMS4D(3)

  IF(ALLOCATED(  rfld).EQV..FALSE.) ALLOCATE(  rfld(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3),nflds))
  DO iREC=1,nREC
   CALL READNETCDF(TRIM(NETCDFFNAME),iREC,LX3D(:,1,1),LY3D(1,:,1),LZ3D(1,1,:),RUNTIME,rfld,DIMSNAME,DIMSUNIT,FLDSNAME,FLDSUNIT)
   CALL FieldsPlot("yz",LX3D,LY3D,LZ3D,rfld,iREC,REAL(RUNTIME,4))
  END DO
  STOP

  D1MAT12=MATDIMS4D(1)/2+1
  D2MAT12=MATDIMS4D(2)/2+1
  D3MAT12=MATDIMS4D(3)/2+1

  D1MAT23=(MATDIMS4D(1)-1)/3-1
  D2MAT23=(MATDIMS4D(2)-1)/3-1
  D3MAT23=(MATDIMS4D(3)-1)/3-1


  IF(ALLOCATED(  rfld).EQV..FALSE.) ALLOCATE(  rfld(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3),nflds))
  IF(ALLOCATED(   rEy).EQV..FALSE.) ALLOCATE(   rEy(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(   rEz).EQV..FALSE.) ALLOCATE(   rEz(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(  rVey).EQV..FALSE.) ALLOCATE(  rVey(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(  rVez).EQV..FALSE.) ALLOCATE(  rVez(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(  rViy).EQV..FALSE.) ALLOCATE(  rViy(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(  rViz).EQV..FALSE.) ALLOCATE(  rViz(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(rFnvey).EQV..FALSE.) ALLOCATE(rFnvey(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(rFnvez).EQV..FALSE.) ALLOCATE(rFnvez(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
 !IF(ALLOCATED(rFnviy).EQV..FALSE.) ALLOCATE(rFnviy(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
 !IF(ALLOCATED(rFnviz).EQV..FALSE.) ALLOCATE(rFnviz(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3)))
  IF(ALLOCATED(  kfld).EQV..FALSE.) ALLOCATE(  kfld(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3),nflds))
  IF(ALLOCATED(   kEy).EQV..FALSE.) ALLOCATE(   kEy(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
  IF(ALLOCATED(   kEz).EQV..FALSE.) ALLOCATE(   kEz(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
 !IF(ALLOCATED(  kVey).EQV..FALSE.) ALLOCATE(  kVey(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
 !IF(ALLOCATED(  kVez).EQV..FALSE.) ALLOCATE(  kVez(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
  IF(ALLOCATED(  kViy).EQV..FALSE.) ALLOCATE(  kViy(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
  IF(ALLOCATED(  kViz).EQV..FALSE.) ALLOCATE(  kViz(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
  IF(ALLOCATED(kFnvey).EQV..FALSE.) ALLOCATE(kFnvey(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
  IF(ALLOCATED(kFnvez).EQV..FALSE.) ALLOCATE(kFnvez(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
 !IF(ALLOCATED(kFnviy).EQV..FALSE.) ALLOCATE(kFnviy(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
 !IF(ALLOCATED(kFnviz).EQV..FALSE.) ALLOCATE(kFnviz(MATDIMS4D(1),MATDIMS4D(2)/2+1,MATDIMS4D(3)))
 !rfld=0.0d0;   kfld=0.0d0
 !rEy=0.0d0;    kEy=0.0d0
 !rEz=0.0d0;    kEz=0.0d0
 !rVey=0.0d0;   kVey=0.0d0
 !rVez=0.0d0;   kVez=0.0d0
 !rViy=0.0d0;   kViy=0.0d0
 !rViz=0.0d0;   kViz=0.0d0
 !rFnvey=0.0d0; kFnvey=0.0d0
 !rFnvez=0.0d0; kFnvez=0.0d0
 !rFnviy=0.0d0; kFnviy=0.0d0
 !rFnviz=0.0d0; kFnviz=0.0d0

  DO iREC=4,nREC
   CALL READNETCDF(TRIM(NETCDFFNAME),iREC,LX3D(:,1,1),LY3D(1,:,1),LZ3D(1,1,:),RUNTIME,rfld,DIMSNAME,DIMSUNIT,FLDSNAME,FLDSUNIT)
   IF(RUNTIME.GE.0.75) THEN
    iTREC=iTREC+1
   END IF
  END DO

  IF(ALLOCATED(rTIME ) .EQV..FALSE.) ALLOCATE(  rTIME(iTREC))
  IF(ALLOCATED(kTIME ) .EQV..FALSE.) ALLOCATE(  kTIME((iTREC)/2+1))
 !IF(ALLOCATED(rTIME ) .EQV..FALSE.) ALLOCATE(  rTIME(iTREC-3))
 !IF(ALLOCATED(kTIME ) .EQV..FALSE.) ALLOCATE(  kTIME((iTREC-3)/2+1))
  IF(ALLOCATED(rNeSTD) .EQV..FALSE.) ALLOCATE(rNeSTD(iTREC,2))
  IF(ALLOCATED(kNeSTD) .EQV..FALSE.) ALLOCATE(kNeSTD(iTREC))
  IF(ALLOCATED(rEyAVG) .EQV..FALSE.) ALLOCATE(rEyAVG(iTREC))
  IF(ALLOCATED(rEzAVG) .EQV..FALSE.) ALLOCATE(rEzAVG(iTREC))
  IF(ALLOCATED(rEytAVG) .EQV..FALSE.) ALLOCATE(rEytAVG(MATDIMS4D(2),iTREC-3))
  IF(ALLOCATED(rEztAVG) .EQV..FALSE.) ALLOCATE(rEztAVG(MATDIMS4D(3),iTREC-3))
  IF(ALLOCATED(rNLSRT) .EQV..FALSE.) ALLOCATE(rNLSRT(iTREC))
  IF(ALLOCATED(rVeyAVG).EQV..FALSE.) ALLOCATE(rVeyAVG(iTREC))
  IF(ALLOCATED(rVezAVG).EQV..FALSE.) ALLOCATE(rVezAVG(iTREC))
  IF(ALLOCATED(rViyAVG).EQV..FALSE.) ALLOCATE(rViyAVG(iTREC))
  IF(ALLOCATED(rVizAVG).EQV..FALSE.) ALLOCATE(rVizAVG(iTREC))
  IF(ALLOCATED(rnVeyAVG).EQV..FALSE.) ALLOCATE(rnVeyAVG(iTREC))
  IF(ALLOCATED(rnVezAVG).EQV..FALSE.) ALLOCATE(rnVezAVG(iTREC))
  IF(ALLOCATED(efldKy).EQV..FALSE.) ALLOCATE(efldKy(D2MAT23,nflds,iTREC))
  IF(ALLOCATED(efldKz).EQV..FALSE.) ALLOCATE(efldKz(D3MAT23,nflds,iTREC))
  IF(ALLOCATED(efldKyAVG).EQV..FALSE.) ALLOCATE(efldKyAVG(D2MAT23,nflds))
  IF(ALLOCATED(efldKzAVG).EQV..FALSE.) ALLOCATE(efldKzAVG(D3MAT23,nflds))
  IF(ALLOCATED(rwNe) .EQV..FALSE.) ALLOCATE(rwNe(iTREC))
  IF(ALLOCATED(kwNe) .EQV..FALSE.) ALLOCATE(kwNe(iTREC/2+1))
  efldKy=0.0d0
  efldKz=0.0d0

  IF(ALLOCATED(rNyt).EQV..FALSE.)     ALLOCATE(rNyt(LYDIM,iTREC))
  IF(ALLOCATED(rNzt).EQV..FALSE.)     ALLOCATE(rNzt(LZDIM,iTREC))
  IF(ALLOCATED(sDim).EQV..FALSE.)     ALLOCATE(sDim(LYDIM,iTREC))
  IF(ALLOCATED(tDim).EQV..FALSE.)     ALLOCATE(tDim(LYDIM,iTREC))

  IF(ALLOCATED(exrNyt).EQV..FALSE.)   ALLOCATE(exrNyt(10*LYDIM,10*iTREC))
  IF(ALLOCATED(exrNzt).EQV..FALSE.)   ALLOCATE(exrNzt(10*LZDIM,10*iTREC))
  IF(ALLOCATED(exsDim).EQV..FALSE.)   ALLOCATE(exsDim(10*LYDIM,10*iTREC))
  IF(ALLOCATED(extDim).EQV..FALSE.)   ALLOCATE(extDim(10*LYDIM,10*iTREC))
  exrNyt=0.0d0;exrNzt=0.0d0;exsDim=0.0d0;extDim=0.0d0

  IF(ALLOCATED(rEySTD) .EQV..FALSE.)  ALLOCATE(rEySTD(iTREC))
  IF(ALLOCATED(rEzSTD) .EQV..FALSE.)  ALLOCATE(rEzSTD(iTREC))
  IF(ALLOCATED(rEyPSTD) .EQV..FALSE.) ALLOCATE(rEyPSTD(iTREC))
  IF(ALLOCATED(rEzPSTD) .EQV..FALSE.) ALLOCATE(rEzPSTD(iTREC))
  IF(ALLOCATED(rEyNSTD) .EQV..FALSE.) ALLOCATE(rEyNSTD(iTREC))
  IF(ALLOCATED(rEzNSTD) .EQV..FALSE.) ALLOCATE(rEzNSTD(iTREC))
  rEySTD=0.0d0;rEyPSTD=0.0d0;rEyNSTD=0.0d0
  rEzSTD=0.0d0;rEzPSTD=0.0d0;rEzNSTD=0.0d0

  IF(ALLOCATED(exkfld).EQV..FALSE.)   ALLOCATE(exkfld(LYDIM,LZDIM))
  IF(ALLOCATED(exiKy2D).EQV..FALSE.)  ALLOCATE(exiKy2D(LYDIM,LZDIM))
  IF(ALLOCATED(exiKz2D).EQV..FALSE.)  ALLOCATE(exiKz2D(LYDIM,LZDIM))
  exiKy2D=0.0d0;exiKz2D=0.0d0
  CALL rmFFTalias(iKy2D)
  CALL rmFFTalias(iKz2D)
  CALL exFFTmat(iKy2D,exiKy2D)
  CALL exFFTmat(iKz2D,exiKz2D)

  iTREC=0
  iD1=1
  DO iREC=4,nREC
   CALL READNETCDF(TRIM(NETCDFFNAME),iREC,LX3D(:,1,1),LY3D(1,:,1),LZ3D(1,1,:),RUNTIME,rfld,DIMSNAME,DIMSUNIT,FLDSNAME,FLDSUNIT)
  !CALL FieldsPlot("yz",LX3D,LY3D,LZ3D,rfld,iREC,REAL(RUNTIME,4))

!*********** SPECTRAL ANALYSIS OF STATURATION STATE ***************
  !IF(RUNTIME.GE.0.75) THEN
    iTREC=iTREC+1
    rTIME(iTREC)=RUNTIME
    DO ifld=1,nflds
     CALL FFTW(rfld(1,:,:,ifld),kfld(1,:,:,ifld))
   ! efldKz(:,ifld,iTREC)=SUM(REAL(kfld(1,1:D2MAT23,1:D3MAT23,ifld)*CONJG(kfld(1,1:D2MAT23,1:D3MAT23,ifld)),8),1)
   ! efldKy(:,ifld,iTREC)=SUM(REAL(kfld(1,1:D2MAT23,1:D3MAT23,ifld)*CONJG(kfld(1,1:D2MAT23,1:D3MAT23,ifld)),8),2)
    ! CALL PLOTPROFILE(REAL(AIMAG(iKy2D(1:D2MAT23,1)),4),efldKy(:,ifld,iTREC),(/iTREC,311+(ifld-1),1/))
    !IF(ifld.EQ.nflds) THEN
    ! CALL PLOTPROFILE(REAL(AIMAG(iKz2D(1,1:D3MAT23)),4),efldKz(:,ifld,iTREC),(/iTREC,311+(ifld-1),0/))
    !ELSE
    ! CALL PLOTPROFILE(REAL(AIMAG(iKz2D(1,1:D3MAT23)),4),efldKz(:,ifld,iTREC),(/iTREC,311+(ifld-1),1/))
    !END IF
    END DO
   !rNyt(:,iTREC)=rfld(1,:,ZDIM/2,1)
   !NeMAXLOC2D=MAXLOC(ABS(kfld(1,:,:,1)))
   !kfld(1,NeMAXLOC2D(1)+1:YDIM/2+1,NeMAXLOC2D(2)+1:ZDIM,1)=0.0d0
   !kfld(1,1:NeMAXLOC2D(1)-1,1:NeMAXLOC2D(2)-1,1)=0.0d0
   !kfld(1,NeMAXLOC2D(1),NeMAXLOC2D(2)+1:ZDIM,1)=0.0d0
   !kfld(1,NeMAXLOC2D(1),1:NeMAXLOC2D(2)-1,1)=0.0d0
   !kfld(1,NeMAXLOC2D(1)+1:YDIM/2+1,NeMAXLOC2D(2),1)=0.0d0
   !kfld(1,1:NeMAXLOC2D(1)-1,NeMAXLOC2D(2),1)=0.0d0
   !CALL iFFTW(kfld(1,:,:,1),rNyt(:,iTREC))

!#########################################################
!FINDING PHASE VELOCITY
   !kfld(1,1:YDIM/2+1,5:ZDIM,1)=0.0d0
   !kfld(1,1:YDIM/2+1,1:3,1)=0.0d0
   !CALL iFFTW(kfld(1,:,:,1),rfld(1,:,:,1))
   !rNyt(:,iTREC)=rfld(1,:,ZDIM/2,1)
!#########################################################

   !rwNeMAXVAL=MAXVAL(REAL(kfld(1,:,:,1)*CONJG(kfld(1,:,:,1))))
   !NeMAXLOC2D=MAXLOC(REAL(kfld(1,:,:,1)*CONJG(kfld(1,:,:,1))))
   !PRINT*, RUNTIME,6.28d0/AIMAG(iKy2D(NeMAXLOC2D(1),NeMAXLOC2D(2))),6.28d0/AIMAG(iKz2D(NeMAXLOC2D(1),NeMAXLOC2D(2)))
   !PRINT*, RUNTIME,NeMAXLOC2D,6.28d0/AIMAG(iKy2D(NeMAXLOC2D(1),NeMAXLOC2D(2))),6.28d0/AIMAG(iKz2D(NeMAXLOC2D(1),NeMAXLOC2D(2)))
   !DO iD1=1,YDIM/2+1
   ! DO iD2=1,ZDIM
   !  IF(rwNeMAXVAL.EQ.MAXVAL(REAL(kfld(1,:,:,1)*CONJG(kfld(1,:,:,1))))) PRINT*, iKy2D(iD1,iD2),iKz2D(iD1,iD2)
   ! END DO
   !END DO
   !rwNe(iTREC)=SUM(ABS(kfld(1,:,:,1)))

   !CALL rmFFTalias(kfld(1,:,:,1))
   !CALL exFFTmat(kfld(1,:,:,1),exkfld)
   !IF((iTREC.EQ.1).OR.(iTREC.EQ.13).OR.(iTREC.EQ.20).OR.(iTREC.EQ.33).OR.(iTREC.EQ.72)) THEN
   ! WRITE(NUMSTR,'(f5.3)') rTIME(iTREC)
   ! IF(iD1.LT.5) THEN
   !  CALL PLOTPROFILE(AIMAG(exiKy2D),AIMAG(exiKz2D),ABS(exkfld),(/1,521+2*(iD1-1),1/),(/"TIME ="//TRIM(NUMSTR)//" sec","","","$\delta{n_k}$ (%)"/))
   ! ELSE
   !  CALL PLOTPROFILE(AIMAG(exiKy2D),AIMAG(exiKz2D),ABS(exkfld),(/1,521+2*(iD1-1),0/),(/"TIME ="//TRIM(NUMSTR)//" sec","","","$\delta{n_k}$ (%)"/))
   ! END IF
   ! iD1=iD1+1
   !END IF

   !rNeSTD(iTREC,1)=STDEV(rfld(1,:,:,1))
   !rNeSTD(iTREC,2)=MAXVAL(rfld(1,:,:,1))
   !rNeSTD(iTREC,2)=MEAN(rfld(1,:,:,1))

   !ALLOCATE THE BOUNDARY CONDITIONS ALLOCATABLE ARRAYS
   !CALL RESETBC(nflds)
   !ALLOCATE THE DIFFERENTIATION SCHEMES ARRAYS
   !CALL RESETDSCHEMES(nflds)
   !ALLOCATE THE INTEGRATION SCHEMES ARRAYS
   !CALL RESETISCHEMES(nflds)
   !RESET THE FFTW VARIABLES
   !CALL FFTWRESET(MATDIMS4D(2),MATDIMS4D(3))
   !SET THE FFTW VARIABLES
   !CALL FFTWSET(MATDIMS4D(2),MATDIMS4D(3))
   !PSMDSCHEME=.TRUE.
   !FDMDSCHEME=.TRUE.
   !SET THE INTEGERATION SCHEMES ARRAYS
   !FDMISCHEME=.TRUE.

   !CALL Df(-((KB*Te(1,1,1)/Qe)*rfld(1,:,:,2)),Y3D(1,:,:),rEy(1,:,:),1)
   !CALL Df(-((KB*Te(1,1,1)/Qe)*rfld(1,:,:,2)),Z3D(1,:,:),rEz(1,:,:),1)
   !CALL Df(((KB*Te(1,1,1)/Qe)*TRANSPOSE(rfld(1,:,:,2)))+EPOTEN(1,1,1),Y3D(1,:,:),rEy(1,:,:),1)
   !CALL Df(((KB*Te(1,1,1)/Qe)*TRANSPOSE(rfld(1,:,:,2)))+EPOTEN(1,1,1),Z3D(1,:,:),rEz(1,:,:),1)

   !rVey(1,:,:)= rEz(1,:,:)/Babs(1,1,1)
   !rVez(1,:,:)=-rEy(1,:,:)/Babs(1,1,1)
   !rFnvey(1,:,:)=rfld(1,:,:,1)*rVey(1,:,:)
   !rFnvez(1,:,:)=rfld(1,:,:,1)*rVez(1,:,:)
   !rFnvey=rfld(:,:,:,1)*( rEz/Babs(1,1,1))
   !rFnvez=rfld(:,:,:,1)*(-rEy/Babs(1,1,1))
   !rFnvez=(-rEy/Babs(1,1,1))
   !CALL FFTW(rFnvez,kFnvez)
   !CALL iFFTW( kEy(1,:,:), rEy(1,:,:))

   !rVey(1,:,:)= rEz(1,:,:)/Babs(1,1,1)
   !rVez(1,:,:)=-rEy(1,:,:)/Babs(1,1,1)
   !rFnvey(1,:,:)=rfld(1,:,:,1)*rVey(1,:,:)
   !rFnvez(1,:,:)=rfld(1,:,:,1)*rVez(1,:,:)
   !rFnvey=rfld(:,:,:,1)*( rEz/Babs(1,1,1))
   !rFnvez=rfld(:,:,:,1)*(-rEy/Babs(1,1,1))
   !rFnvez=(-rEy/Babs(1,1,1))
   !CALL FFTW(rFnvez,kFnvez)
   !CALL iFFTW( kEy(1,:,:), rEy(1,:,:))
   !CALL iFFTW( kEz(1,:,:), rEz(1,:,:))
   !rVey(1,:,:)= rEz(1,:,:)/Babs(1,:,:)
   !rVez(1,:,:)=-rEy(1,:,:)/Babs(1,:,:)
   !rFnvey(1,:,:)=rfld(1,:,:,1)*rVey(1,:,:)
   !rFnvez(1,:,:)=rfld(1,:,:,1)*rVez(1,:,:)
   !rFnvey=rfld(:,:,:,1)*( rEz/Babs(1,1,1))
   !rFnvez=rfld(:,:,:,1)*(-rEy/Babs(1,1,1))
   !rFnvez=(-rEy/Babs(1,1,1))
   !CALL FFTW(rFnvez,kFnvez)
   !rFnvey=(rEz/Babs(1,1,1))
   !CALL FFTW(rFnvey,kFnvey)
   !rnveyAVG(iTREC)=MAXVAL(ATAN2(AIMAG(kFnvez),REAL(kFnvez)))
   !rnvezAVG(iTREC)=MINVAL(ATAN2(AIMAG(kFnvez),REAL(kFnvez)))
   !rnveyAVG(iTREC)=MEAN(ATAN2(AIMAG(kFnvey),REAL(kFnvey)))
   !rnvezAVG(iTREC)=MEAN(ATAN2(AIMAG(kFnvez),REAL(kFnvez)))
   !rnveyAVG(iTREC)=MAXVAL(AIMAG(rFnvez)/REAL(rFnvez))
   !rnvezAVG(iTREC)=MINVAL(AIMAG(rFnvez)/REAL(rFnvez))

   !rEyAVG(iTREC)= (MAXVAL(rEy(1,:,:)) +MINVAL(rEy(1,:,:)))
   !rEzAVG(iTREC)= (MAXVAL(rEz(1,:,:)) +MINVAL(rEz(1,:,:)))
   !rVeyAVG(iTREC)=(MAXVAL(rVey(1,:,:))+MINVAL(rVey(1,:,:)))
   !rVezAVG(iTREC)=(MAXVAL(rVez(1,:,:))+MINVAL(rVez(1,:,:)))
   !rEySTD(iTREC)=STDEV(rEy(1,:,:))
   !rEzSTD(iTREC)=STDEV(rEz(1,:,:))


!############################################################################################################# 
! CALCULATING THE ELECTRIC FIELD
   !kEy(1,:,:)=-iKy2D*((KB*Te(1,1,1)/Qe)*kfld(1,:,:,2))
   !kEz(1,:,:)=-iKz2D*((KB*Te(1,1,1)/Qe)*kfld(1,:,:,2))
   !CALL iFFTW( kEy(1,:,:), rEy(1,:,:))
   !CALL iFFTW( kEz(1,:,:), rEz(1,:,:))
!############################################################################################################# 


   !nPrEy=0;nPrEz=0;nNrEy=0;nNrEz=0
   !DO iD1=1,LYDIM
   ! DO  iD2=1,LZDIM
   !  rEySTD(iTREC)=rEySTD(iTREC)+rEy(1,iD1,iD2)**2
   !  IF(rEy(1,iD1,iD2).GT.0.0d0) THEN
   !   rEyPSTD(iTREC)=rEyPSTD(iTREC)+rEy(1,iD1,iD2)**2
   !   nPrEy=nPrEy+1
   !  END IF
   !  IF(rEy(1,iD1,iD2).LT.0.0d0) THEN
   !   rEyNSTD(iTREC)=rEyNSTD(iTREC)+rEy(1,iD1,iD2)**2
   !   nNrEy=nNrEy+1
   !  END IF
   ! END DO
   !END DO
   !rEySTD(iTREC)=SQRT(rEySTD(iTREC)/(LYDIM*LZDIM))
   !rEyPSTD(iTREC)=SQRT(rEyPSTD(iTREC)/nPrEy)
   !rEyNSTD(iTREC)=SQRT(rEyNSTD(iTREC)/nNrEy)
   !DO iD1=1,LYDIM
   ! DO  iD2=1,LZDIM
   !  rEzSTD(iTREC)=rEzSTD(iTREC)+rEz(1,iD1,iD2)**2
   !  IF(rEz(1,iD1,iD2).GT.0.0d0) THEN
   !   rEzPSTD(iTREC)=rEzPSTD(iTREC)+rEz(1,iD1,iD2)**2
   !   nPrEz=nPrEz+1
   !  END IF
   !  IF(rEz(1,iD1,iD2).LT.0.0d0) THEN
   !   rEzNSTD(iTREC)=rEzNSTD(iTREC)+rEz(1,iD1,iD2)**2
   !   nNrEz=nNrEz+1
   !  END IF
   ! END DO
   !END DO
   !rEzSTD(iTREC)=SQRT(rEzSTD(iTREC)/(LYDIM*LZDIM))
   !rEzPSTD(iTREC)=SQRT(rEzPSTD(iTREC)/nPrEz)
   !rEzNSTD(iTREC)=SQRT(rEzNSTD(iTREC)/nNrEz)

!########################################################################################################################################################################################
! PLOTING THE DENSITY PERTUBATION
    IF((iTREC.LE.15)) THEN
     WRITE(NUMSTR,'(f5.3)') rTIME(iTREC)
     CALL PLOTPROFILE(Y3D(1,:,:),Z3D(1,:,:),100.0d0*rfld(1,:,:,1),(/iTREC,111,0/),(/"TIME ="//TRIM(NUMSTR)//" sec","East-West (m)","Altitude (m)","$\delta{n}$ (%)"/))
    END IF
!########################################################################################################################################################################################

  ! IF((iTREC.EQ.90)) THEN
  !  WRITE(NUMSTR,'(f5.3)') rTIME(iTREC)
    !CALL PLOTPROFILE(Y3D(1,:,:),Z3D(1,:,:),100.0d0*rfld(1,:,:,1),(/iTREC,111,0/),(/"TIME ="//TRIM(NUMSTR)//" sec","East-West (m)","Altitude (m)","$\delta{n}$ (%)"/))
  !  CALL PLOTPROFILE(Y3D(1,:,:),Z3D(1,:,:),1000.0d0*rEy(1,:,:),(/2*iTREC,111,0/),(/"TIME ="//TRIM(NUMSTR)//" sec","East-West (m)\n(a)","Altitude (m)","$\delta{Ey}$ ($\frac{mV}{m}$)"/))
  !  CALL PLOTPROFILE(Y3D(1,:,:),Z3D(1,:,:),1000.0d0*rEz(1,:,:),(/2*iTREC+1,111,0/),(/"TIME ="//TRIM(NUMSTR)//" sec","East-West (m)\n(c)","Altitude (m)","$\delta{Ez}$ ($\frac{mV}{m}$)"/))
    !CALL PLOTPROFILE(Y3D(1,:,:),Z3D(1,:,:),rEy(1,:,:),(/iTREC,111,0/),(/"TIME ="//TRIM(NUMSTR)//" sec","East-West (m)","Altitude (m)","$\delta{Ey}$ ($\frac{mV}{m}$)"/))
  ! END IF


   !rVeyAVG(iTREC)=STDEV(rVey(1,:,:))
   !rVezAVG(iTREC)=STDEV(rVez(1,:,:))
   !rEyAVG(iTREC)=MAXVAL(rEz(1,:,:))
   !rEzAVG(iTREC)=MINVAL(rEz(1,:,:))
   !rVeyAVG(iTREC)=MAXVAL(rVey(1,:,:))
   !rVezAVG(iTREC)=MAXVAL(rVez(1,:,:))
   !rnVeyAVG(iTREC)=MEAN(rFnvey)
   !rnVezAVG(iTREC)=MEAN(rFnvez)
   !rnVeyAVG(iTREC)=rNeSTD(iTREC,2)*rVeyAVG(iTREC)
   !rnVezAVG(iTREC)=rNeSTD(iTREC,2)*rVezAVG(iTREC)
   !rnVezAVG(iTREC)=-Lne(1,1,1)*MEAN(rFnvez)/Ne(1,1,1)
   !kViy(1,:,:)=-iKy2D*kfld(1,:,:,3)
   !kViz(1,:,:)=-iKz2D*kfld(1,:,:,3)
   !CALL iFFTW(kViy(1,:,:),rViy(1,:,:))
   !CALL iFFTW(kViz(1,:,:),rViz(1,:,:))
   !rViyAVG(iTREC)=MAXVAL(rViy(1,:,:))
   !rVizAVG(iTREC)=MAXVAL(rViz(1,:,:))

   !rEyAVG(iTREC)=MINVAL((KB*Te(1,1,1)/Qe)*rEy(1,:,:))
   !rEzAVG(iTREC)=MAXVAL((KB*Te(1,1,1)/Qe)*rEy(1,:,:))
   !rVeyAVG(iTREC)= rEzAVG(iTREC)/Babs(1,1,1)
   !rVezAVG(iTREC)=-rEyAVG(iTREC)/Babs(1,1,1)
   !rVeyAVG(iTREC)= rEyAVG(iTREC)/Babs(1,1,1)
   !rVezAVG(iTREC)= rEzAVG(iTREC)/Babs(1,1,1)
   !rnVeyAVG(iTREC)=rNeSTD(iTREC,2)*rVeyAVG(iTREC)
   !rnVezAVG(iTREC)=rNeSTD(iTREC,2)*rVezAVG(iTREC)
   !kViy(1,:,:)=-iKy2D*kfld(1,:,:,3)
   !kViz(1,:,:)=-iKz2D*kfld(1,:,:,3)
   !CALL iFFTW(kViy(1,:,:),rViy(1,:,:))
   !CALL iFFTW(kViz(1,:,:),rViz(1,:,:))
   !rViyAVG(iTREC)=MAXVAL(rViy(1,:,:))
   !rVizAVG(iTREC)=MAXVAL(rViz(1,:,:))

   !rnVezAVG(iTREC)=SKEWNESS(rfld(1,:,:,1))
   !rnVezAVG(iTREC)=KURTOSIS(rfld(1,:,:,1))
  !END IF
  END DO
!STOP
 !CALL MESHGRID(Y3D(1,:,1),rTIME,sDim,tDIM)
 !CALL MESHGRID(Y3D(1,:,1),rTIME,exsDim,extDIM)
 !CALL iSMOOTH("python","cubic",sDim,tDim,rNyt,exsDim,extDim,exrNyt) 
 !OPEN(UNIT=102,FILE="PhaseVelocity.dat",STATUS='NEW',ACTION='WRITE',IOSTAT=ferror)
 !IF(ferror.NE.0) OPEN(UNIT=102,FILE="PhaseVelocity.dat",STATUS='REPLACE',ACTION='WRITE',IOSTAT=ferror)
 !DO iDIM2=1,SIZE(rTIME)
 ! DO iDIM1=1,SIZE(Y3D(1,:,1))
 !  WRITE(102,"(1ES15.8,T23,1ES15.8,T46,1ES15.8)") sDim(iDIM1,iDIM2),tDim(iDIM1,iDIM2),rNyt(iDIM1,iDIM2)
 ! END DO
 !END DO
 !CLOSE(102)

!############################################################################################################# 
! PLOTING PHASE VELOCITY
 !CALL MESHGRID(Y3D(1,:,1),rTIME,sDim,tDIM)
 !CALL PLOTPROFILE(sDIM,tDim,100.0d0*rNyt,(/1,111,0/),(/"","East-West (m)","Time (sec)","$\delta{n}$ (%)"/))
!############################################################################################################# 

 !CALL FFTW(rwNe,kwNE)
 !CALL LINVECTOR(6.28d0/(rTIME(SIZE(rTIME))-rTIME(1)),3.14d0/(rTIME(2)-rTIME(1)),SIZE(kTIME),kTIME)
 !PRINT*, 6.28d0/(rTIME(SIZE(rTIME))-rTIME(1)), 3.14d0/(rTIME(2)-rTIME(1))  
 !CALL PLOTPROFILE(kTIME,REAL(kwNe*CONJG(kwNe)),(/1,211,0/),(/"","","","k"/))

 !DO iD2=1,D2MAT23
 ! efldKyAVG(iD2,1)=MEAN(efldKy(iD2,1,:))
 !END DO
 !CALL PLOTPROFILE(REAL(AIMAG(iKy2D(1:D2MAT23,1)),4),efldKyAVG(:,1),(/1,211,1/))
!!CALL PLOTPROFILE((/10.0,22.0/),(/1000000.0d0,1000.0d0/),(/1,211,0/))

 !DO ifld=1,nflds
 ! DO iD2=1,D2MAT23
 !  efldKyAVG(iD2,ifld)=MEAN(efldKy(iD2,ifld,:))
 ! END DO
 ! CALL PLOTPROFILE(REAL(AIMAG(iKy2D(1:D2MAT23,1)),4),efldKyAVG(:,ifld),(/1,311+(ifld-1),1/))
 !END DO
 !DO ifld=1,nflds
 ! DO iD3=1,D3MAT23
 !  efldKzAVG(iD3,ifld)=MEAN(efldKz(iD3,ifld,:))
 ! END DO
 ! IF(ifld.EQ.nflds) THEN
 !  CALL PLOTPROFILE(REAL(AIMAG(iKz2D(1,1:D3MAT23)),4),efldKzAVG(:,ifld),(/1,311+(ifld-1),0/))
 ! ELSE
 !  CALL PLOTPROFILE(REAL(AIMAG(iKz2D(1,1:D3MAT23)),4),efldKzAVG(:,ifld),(/1,311+(ifld-1),1/))
 ! END IF
 !END DO

 !rNLSRT=0.7d0

 !CALL PLOTPROFILE(rTIME,1000.0d0*rEyAVG,(/7,211,0/),(/"Perturbed Zonal Electric Fields","Time (sec)","$<\delta{E_{y}(z=0,t)}> (\\frac{mV}{m})$","r"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEzAVG,(/6,211,0/),(/"Perturbed Vertical Electric Fields","Time (sec)","$<\delta{E_{z}(y=0,t)}> (\\frac{mV}{m})$","b"/))

 !CALL PLOTPROFILE(rTIME,1000.0d0*rEyAVG,(/2,211,1/),(/"","","","r","$\delta{E_y\\rightarrow}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEzAVG,(/2,211,0/),(/"Perturbed Electric Fields","Time (sec)","$\delta{E_{y}} (\\frac{mV}{m})$","b","$\delta{E_y\leftarrow}$"/))

!!CALL PLOTPROFILE(rNLSRT,100.0d0*rNeSTD(:,2),(/1,211,1/),(/"","","","k"/))
! CALL PLOTPROFILE(rTIME,100.0d0*rNeSTD(:,1),(/1,211,1/),(/"","","","r","$\sigma_{\delta{n}}$(%)"/))
! CALL PLOTPROFILE(rTIME,100.0d0*rNeSTD(:,2),(/1,211,0/),(/"Perturbed Density","Time (sec)","$\sigma_{\delta{n}},\\delta{n}$(%)","b","$\delta{n}$(%)"/))
!!CALL PLOTPROFILE(rNLSRT,1000.0d0*rEzAVG,(/2,211,1/),(/"","","","k"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEyPSTD,(/2,211,1/),(/"","","","r","$\sigma_{\delta{E^+_y}}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEySTD,(/2,211,1/),(/"","","","k","$\sigma_{\delta{E_y}}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEyNSTD,(/2,211,0/),(/"","Time (sec)\n(b)","$\sigma_{\delta{E_{y}}} (\\frac{mV}{m})$","b","$\sigma_{\delta{E^-_y}}$"/))
!!CALL PLOTPROFILE(rTIME,1000.0d0*rEyNSTD,(/2,211,0/),(/"Perturbed Electric Fields","Time (sec) \\n (b)","$\sigma_{\delta{E_{y}}} (\\frac{mV}{m})$","b","$\sigma_{\delta{E^-_y}}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEzPSTD,(/3,211,1/),(/"","","","r","$\sigma_{\delta{E^+_z}}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEzSTD,(/3,211,1/),(/"","","","k","$\sigma_{\delta{E_z}}$"/))
 !CALL PLOTPROFILE(rTIME,1000.0d0*rEzNSTD,(/3,211,0/),(/"","Time (sec)\n(d)","$\sigma_{\delta{E_{z}}} (\\frac{mV}{m})$","b","$\sigma_{\delta{E^-_z}}$"/))
!!CALL PLOTPROFILE(rTIME,1000.0d0*rEzNSTD,(/3,211,0/),(/"Perturbed Electric Fields","Time (sec) \\n (d)","$\sigma_{\delta{E_{z}}} (\\frac{mV}{m})$","b","]sigma_{$\delta{E^-_z}}$"/))
!!CALL plotprofile(rNLSRT,rVeyAVG,(/3,211,1/),(/"","","","k"/))
! CALL PLOTPROFILE(rTIME,rVeyAVG,(/3,211,1/),(/"","","","r","$\delta{\upsilon_{ey}}$"/))
! CALL PLOTPROFILE(rTIME,rVezAVG,(/3,211,0/),(/"Perturbed Electron Drifts","Time (sec)","$\delta{\upsilon_{ey,ez}} (\\frac{m}{s})$","b","$\delta{\upsilon_{ez}}$"/))
!!CALL plotprofile(rNLSRT,rViyAVG,(/4,211,1/),(/"","","","k"/))
 !CALL PLOTPROFILE(rTIME,rViyAVG,(/4,211,1/),(/"","","","r","$\delta{\upsilon_{iy}}$"/))
 !CALL PLOTPROFILE(rTIME,rVizAVG,(/4,211,0/),(/"Perturbed Ion Drifts","Time (sec)","$\delta{\upsilon_{iy,iz}} (\\frac{m}{s})$","b","$\delta{\upsilon_{iz}}$"/))
!!CALL plotprofile(rNLSRT,rnVeyAVG,(/5,211,1/),(/"","","","k"/))
! CALL PLOTPROFILE(rTIME,rnVeyAVG,(/5,211,1/),(/"","","","r","$\Gamma_e={n\upsilon_{ey}}$"/))
! CALL PLOTPROFILE(rTIME,rnVezAVG,(/5,211,0/),(/"Perturbed Particle Density Flux","Time (sec)","$\Gamma_e={n\upsilon_{ey,ez}} (\\frac{1}{m^2s})$","b","$\Gamma_e={n\upsilon_{ez}}$"/))
 !CALL PLOTPROFILE(rTIME,rnVezAVG,(/5,211,0/),(/"Kurtosis of Density Perturbation","Time (sec)","Kurtosis","k"/))

 !PRINT*, rEyAVG(SIZE(rEyAVG))
 !PRINT*, rEzAVG(SIZE(rEzAVG))
 !PRINT*, rVeyAVG(SIZE(rVeyAVG))
 !PRINT*, rVezAVG(SIZE(rVezAVG))
 !PRINT*, 100.0d0*MEAN(rNeSTD(:,2))
 !PRINT*, 1000.0d0*MEAN(rEyAVG)
 !PRINT*, 1000.0d0*MEAN(rEzAVG)
 !PRINT*, MEAN(rVeyAVG)
 !PRINT*, MEAN(rVezAVG)

  RETURN
 END SUBROUTINE r4FieldsPlotNETCDF

 SUBROUTINE r8FieldsPlotNETCDF(PLTSPACES,LX3D,LY3D,LZ3D,NETCDFFNAME,FLDSNAME,DIMSNAME,rplotType,kplotType)
  USE RDSVNETCDF
  IMPLICIT NONE
!*************** INPUT VARIABLES DECLARATION *******************
  REAL(8),     INTENT(INOUT)        :: LX3D(:,:,:),LY3D(:,:,:),LZ3D(:,:,:)
  CHARACTER(*),INTENT(IN)           :: PLTSPACES
  CHARACTER(*),INTENT(IN)           :: NETCDFFNAME
  CHARACTER(*),INTENT(INOUT)        :: FLDSNAME(:)
  CHARACTER(*),INTENT(INOUT)        :: DIMSNAME(:)
  CHARACTER(*),INTENT(IN),OPTIONAL  :: rplotType,kplotType
!************** LOCAL VARIABLES DECLARATION ********************
  REAL(8),     ALLOCATABLE          :: fld(:,:,:,:)
  REAL(4)                           :: RUNTIME
  INTEGER(4)                        :: nDIMS,nVARS,nREC
  INTEGER(4)                        :: MATDIMS4D(4)
  INTEGER(4)                        :: iREC,nflds
  CHARACTER(25)                     :: FLDSUNIT(3)
  CHARACTER(25)                     :: DIMSUNIT(4)


  CALL NETCDF_INFO(TRIM(NETCDFFNAME),nDIMS,nVARS)
  CALL NETCDF_VAR_DIMS(TRIM(NETCDFFNAME),TRIM(FLDSNAME(1)),MATDIMS4D)
  nflds=nVARS-nDIMS
  nREC=MATDIMS4D(4)

  IF(ALLOCATED(fld).EQV..FALSE.) ALLOCATE(fld(MATDIMS4D(1),MATDIMS4D(2),MATDIMS4D(3),nflds))

  DO iREC=1,nREC
   CALL READNETCDF(TRIM(NETCDFFNAME),iREC,X3D(:,1,1),Y3D(1,:,1),Z3D(1,1,:),RUNTIME,fld,DIMSNAME,DIMSUNIT,FLDSNAME,FLDSUNIT)
   CALL FieldsPlot("yz",LX3D,LY3D,LZ3D,fld,iREC,REAL(RUNTIME,4))
  END DO

  RETURN
 END SUBROUTINE r8FieldsPlotNETCDF

 SUBROUTINE r4r8FieldsPlot(PLTSPACES,LX3D,LY3D,LZ3D,flds,PLOTID,runtime,rplotType,kplotType)
  IMPLICIT NONE
!*************** INPUT VARIABLES DECLARATION *******************
  REAL(4),     INTENT(INOUT)        :: LX3D(:,:,:),LY3D(:,:,:),LZ3D(:,:,:)
  REAL(8),     INTENT(IN)           :: flds(:,:,:,:)
  REAL(4),     INTENT(IN)           :: RUNTIME
  INTEGER(4),  INTENT(IN)           :: PLOTID
  CHARACTER(*),INTENT(IN)           :: PLTSPACES
  CHARACTER(*),INTENT(IN),OPTIONAL  :: rplotType,kplotType

  REAL(8),     ALLOCATABLE          :: LLX3D(:,:,:),LLY3D(:,:,:),LLZ3D(:,:,:)
  INTEGER(4)                        :: iXDIM,iYDIM,iZDIM
  INTEGER(4)                        :: MATDIMS3D(3)

  MATDIMS3D=SHAPE(LX3D)
  IF(ALLOCATED(LLX3D).EQV..FALSE.) ALLOCATE(LLX3D(MATDIMS3D(1),MATDIMS3D(2),MATDIMS3D(3)))
  IF(ALLOCATED(LLY3D).EQV..FALSE.) ALLOCATE(LLY3D(MATDIMS3D(1),MATDIMS3D(2),MATDIMS3D(3)))
  IF(ALLOCATED(LLZ3D).EQV..FALSE.) ALLOCATE(LLZ3D(MATDIMS3D(1),MATDIMS3D(2),MATDIMS3D(3)))
  LLX3D=1.0d0*LX3D
  LLY3D=1.0d0*LY3D
  LLZ3D=1.0d0*LZ3D

  CALL FieldsPlot(PLTSPACES,LLX3D,LLY3D,LLZ3D,flds,PLOTID,runtime,rplotType,kplotType)

  DO iXDIM=1,MATDIMS3D(1)
   DO iYDIM=1,MATDIMS3D(2)
    DO iZDIM=1,MATDIMS3D(3)
     LX3D(iXDIM,iYDIM,iZDIM)=REAL(LLX3D(iXDIM,iYDIM,iZDIM),4)
     LY3D(iXDIM,iYDIM,iZDIM)=REAL(LLY3D(iXDIM,iYDIM,iZDIM),4)
     LZ3D(iXDIM,iYDIM,iZDIM)=REAL(LLZ3D(iXDIM,iYDIM,iZDIM),4)
    END DO
   END DO
  END DO

  RETURN
 END SUBROUTINE r4r8FieldsPlot

 SUBROUTINE r8r8FieldsPlot(PLTSPACES,LX3D,LY3D,LZ3D,flds,PLOTID,runtime,rplotType,kplotType)
  IMPLICIT NONE
!*************** INPUT VARIABLES DECLARATION *******************
  REAL(8),     INTENT(INOUT)        :: LX3D(:,:,:),LY3D(:,:,:),LZ3D(:,:,:)
  REAL(8),     INTENT(IN)           :: flds(:,:,:,:)
  REAL(4),     INTENT(IN)           :: RUNTIME
  INTEGER(4),  INTENT(IN)           :: PLOTID
  CHARACTER(*),INTENT(IN)           :: PLTSPACES
  CHARACTER(*),INTENT(IN),OPTIONAL  :: rplotType,kplotType
!************** TIME VARIABLES DECLARATIONS ********************
  REAL(4)                :: ITIME
  INTEGER(4)             :: HRnum,MINnum,SECnum,TEMPnum
  CHARACTER*2            :: HRstr,MINstr,SECstr,TEMPstr
  CHARACTER*12           :: txtRUNTIME
!***************** FORTGRAPHER PARAMETERS **********************
  INTEGER(4)             :: GFC(10)
  CHARACTER*25           :: FNAME=""
  CHARACTER*100          :: GA(100)=""
  CHARACTER*100          :: GX(100)=""
!*********************** OTHER VARIABLES ***********************
  REAL(8),   ALLOCATABLE :: LLAT3D(:,:,:),LLON3D(:,:,:),LALT3D(:,:,:)
  REAL(8),   ALLOCATABLE :: FLDENERGY(:)
  COMPLEX(8),ALLOCATABLE ::  kfld1D(:), kfld2D(:,:), kfld3D(:,:,:)
  COMPLEX(8),ALLOCATABLE :: Gkfld1D(:),Gkfld2D(:,:),Gkfld3D(:,:,:)
  COMPLEX(8),ALLOCATABLE :: exkfld(:,:,:)
  COMPLEX(8),ALLOCATABLE :: exiKx1D(:)  ,exiKy1D(:)  ,exiKz1D(:)
  COMPLEX(8),ALLOCATABLE :: exiKx2D(:,:),exiKy2D(:,:),exiKz2D(:,:)
  COMPLEX(8),ALLOCATABLE :: liKx1D(:)  ,liKy1D(:)  ,liKz1D(:)
  COMPLEX(8),ALLOCATABLE :: liKx2D(:,:),liKy2D(:,:),liKz2D(:,:)
  INTEGER(4)             :: SPCDIMS
  INTEGER(4)             :: I,J,K
  INTEGER(4)             :: LXDIM,LYDIM,LZDIM,Lnfld
  INTEGER(4)             :: D1MAT23,D2MAT23,D3MAT23
  INTEGER(4)             :: D1MAT12,D2MAT12,D3MAT12
  INTEGER(4)             :: MATDIMS(4)
  INTEGER(4),SAVE        :: ACCESSID=1
  CHARACTER*20,ALLOCATABLE,SAVE      :: NUM2STR(:)

  SPCDIMS=LEN(TRIM(PLTSPACES))

!********* INITIALIZE LOCAL VARIABLE LAT,LON, AND ALT ***********
  MATDIMS=SHAPE(flds)
  LXDIM=MATDIMS(1);LYDIM=MATDIMS(2);LZDIM=MATDIMS(3);Lnfld=MATDIMS(4)
  D1MAT23=((LXDIM-1)/3)-1;D2MAT23=((LYDIM-1)/3)-1;D3MAT23=((LZDIM-1)/3)-1
  D1MAT12=LXDIM/2+1;D2MAT12=LYDIM/2+1;D3MAT12=LZDIM/2+1;
  IF(ALLOCATED(NUM2STR).EQV..FALSE.) ALLOCATE(NUM2STR(Lnfld))

  IF(ALLOCATED(exkfld)) DEALLOCATE(exkfld)
  ALLOCATE(exkfld(LXDIM,LYDIM,LZDIM))

!********** CONVERT THE TIME INTO A UT: HH:MM:SS *****************
  ITIME=INT(RUNTIME)
  HRnum=ITIME/3600
  TEMPnum=ITIME-(3600*HRnum)
  MINnum=TEMPnum/60
  SECnum=MOD(TEMPnum,60)
  IF(HRnum.GE.10) THEN
    write(TEMPstr,'(I2)') HRnum
    HRstr=TEMPstr
  ELSE
    write(TEMPstr,'(I1)') HRnum
    HRstr=char(48)//TRIM(TEMPstr)
  ENDIF
  write(TEMPstr,'(I2)') MINnum
  IF(MINnum.GE.10) THEN
    write(TEMPstr,'(I2)') MINnum
    MINstr=TEMPstr
  ELSE
    write(TEMPstr,'(I1)') MINnum
    MINstr=char(48)//TRIM(TEMPstr)
  ENDIF
  write(TEMPstr,'(I2)') SECnum
  IF(SECnum.GE.10) THEN
    write(TEMPstr,'(I2)') SECnum
    SECstr=TEMPstr
  ELSE
    write(TEMPstr,'(I1)') SECnum
    SECstr=char(48)//TRIM(TEMPstr)
  ENDIF

 !GA(SUPERTITLE)="UT: "//TRIM(HRstr)//":"//TRIM(MINstr)//":"//TRIM(SECstr)

  DO I=1,Lnfld
   IF(ACCESSID.EQ.1) WRITE(NUM2STR(I),'(E10.5)') MAXVAL(flds(:,:,:,I))
   IF(I.EQ.1) THEN
    IF(rfldPLOT.AND.kfldPLOT) THEN
     FNAME="Field1"
    ELSE IF(rfldPLOT) THEN
     FNAME="rField1"
    ELSE IF(kfldPLOT) THEN
     FNAME="kField1"
    END IF
   ENDIF 
   IF(I.EQ.2) THEN
    IF(rfldPLOT.AND.kfldPLOT) THEN
     FNAME="Field2"
    ELSE IF(rfldPLOT) THEN
     FNAME="rField2"
    ELSE IF(kfldPLOT) THEN
     FNAME="kField2"
    END IF
   ENDIF
   IF(I.EQ.3) THEN
    IF(rfldPLOT.AND.kfldPLOT) THEN
     FNAME="Field3"
    ELSE IF(rfldPLOT) THEN
     FNAME="rField3"
    ELSE IF(kfldPLOT) THEN
     FNAME="kField3"
    END IF
   ENDIF
   GA=""
   GX=""

!  IF(PRESENT(rplotType).AND.PRESENT(kplotType)) THEN
!    IF((rplotType.NE."surface").AND.(kplotType.NE."surface")) GA(FIGSIZE)="(19,10)"
!  ELSE IF(PRESENT(rplotType)) THEN
!    IF(rplotType.NE."surface") GA(FIGSIZE)="(19,10)"
!  END IF
!****************** R-FIELDS PLOT ****************************
   IF(rfldPLOT) THEN
!******** GFC INITIALIZATION ************
    GFC(PLTDPI)=100
    GFC(PLTFIGNUM)=PLOTID
    IF(rfldPLOT.AND.kfldPLOT) THEN
     GFC(PLTSFIGNUM)=221
     GFC(PLTFIGHOLD)=GETVALOF("YES")
    ELSE IF(rfldPLOT) THEN
     GFC(PLTSFIGNUM)=111
     GFC(PLTFIGHOLD)=GETVALOF("NO")
     write(txtRUNTIME,'(1ES9.3)') RUNTIME
    !GA(SUPERTITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
    END IF
    GFC(PLTYYAXES)=GETVALOF("NO")
    GFC(DATTYPE)=GETVALOF("UNFORMATTED")
    GFC(DATSAVE)=GETVALOF("SAVE")
    GFC(PNGSAVE)=GETVALOF("DELETE")
    GFC(PDFSAVE)=GETVALOF("SAVE")
    GFC(MOVNFPS)=GETVALOF("NO")

    IF(PRESENT(rplotType)) THEN
     GA(IPLOT)=TRIM(rplotType)
    ELSE
     GA(IPLOT)="contourf"
    END IF
   !GA(TITLE)="TIME= 0.000 sec"
    write(txtRUNTIME,'(1ES9.3)') RUNTIME
    GA(TITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
    GA(TITLEfs)="8"
    IF(I.EQ.1) THEN
     GA(SUPERTITLE)="Density Pertubation"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
     GA(CBARLWLIMIT)="-12"
     GA(CBARUPLIMIT)=" 12"
     GA(CCBARLEVELS)="50"
     GA(CCBARNORM)="yes"
     GA(CCBARTICKS)="[-12,-10,-8,-6,-4,-2,-0,2,4,6,8,10,12]"
    !GA(CCBARTICKS)="[-6,-4,-2,-0,2,4,6]"
    ENDIF 
    IF(I.EQ.2) THEN
     GA(SUPERTITLE)="Electric Potential"
     GA(CBARTITLE)="$\delta{\varphi}$"
    !GA(CBARLEVELS)="100"
    !GA(CBARNORM)="yes"
    !GA(CBARLWLIMIT)="-0.6"
    !GA(CBARUPLIMIT)=" 0.6"
    !GA(CBARTICKS)="[-0.6,-0.5,-0.4,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,0.4,0.5,0.6]"
    ENDIF
    IF(I.EQ.3) THEN
     GA(SUPERTITLE)="Ion Velocity Potential"
     GA(CBARTITLE)="$\delta{\chi}$"
    !GA(CBARLEVELS)="100"
    !GA(CBARNORM)="yes"
    !GA(CBARLWLIMIT)="-30.0e4"
    !GA(CBARUPLIMIT)=" 80.0e4"
    !GA(CBARTICKS)="[-0.5,-0.4,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,0.4,0.5]"
    !GA(CBARLEVELS)=""
    !GA(CBARNORM)=""
    !GA(CBARLWLIMIT)=""
    !GA(CBARUPLIMIT)=""
    !GA(CBARTICKS)=""
    ENDIF
    IF(SPCDIMS.GT.1) THEN
     GA(ZLABEL)="z-axis"
    !GA(CBAR)="yes"
    !GA(CBARSIZE)="1.0"
!    GA(CBARTITLE)=""
    END IF
    IF((I.EQ.1).AND.(ACCESSID.EQ.1)) THEN
     GFC(PLTSFIGNUM)=111
    !GFC(PLTFIGHOLD)=GETVALOF("YES")
    !GA(XLIMITS)="(-10,10)"
    !GA(YLIMITS)="( 40,60)"
    !GA(IPLOT)="contour"
    !GA(LINEPROP)="k"
     GA(XLABEL)="East-West (m)"
     GA(YLABEL)="Altitude (m)"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
    !GX(1) = " a = axes([.65, .6, .2, .2])"
    !GX(2) = " setp(a, xticks=[], yticks=[])"
    !WRITE(GA(CBARLWLIMIT),'(I3)') NINT(MINVAL(flds(:,:,:,I)))
    !WRITE(GA(CBARUPLIMIT),'(I3)') NINT(MAXVAL(flds(:,:,:,I)))
    ELSE IF((I.EQ.1).AND.(ACCESSID.EQ.2)) THEN
     GFC(PLTSFIGNUM)=111
    !GFC(PLTFIGHOLD)=GETVALOF("YES")
    !GA(XLIMITS)="(-10,10)"
    !GA(YLIMITS)="( 40,60)"
     GA(IPLOT)="contourf"
     GA(XLABEL)="East-West (m)"
     GA(YLABEL)="Altitude (m)"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
    !GX(1) = "a = axes([.65, .6, .2, .2])"
    !GX(2) = "setp(a, xticks=[], yticks=[])"
    !GX(1) = "setp(ax, yticks=[])"
     GA(CBARLWLIMIT)="-6"
     GA(CBARUPLIMIT)=" 6"
     GA(CBARLEVELS)="50"
     GA(CBARNORM)="yes"
     GA(CBARTICKS)="[-6,-4,-2,-0,2,4,6]"
    ELSE IF((I.EQ.1).AND.(ACCESSID.EQ.3)) THEN
     GFC(PLTSFIGNUM)=111
    !GFC(PLTFIGHOLD)=GETVALOF("YES")
    !GA(XLIMITS)="(-10,10)"
    !GA(YLIMITS)="( 40,60)"
     GA(XLABEL)="East-West (m)"
     GA(YLABEL)="Altitude (m)"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
    !GX(1) = "a = axes([.65, .6, .2, .2])"
    !GX(2) = "setp(a, xticks=[], yticks=[])"
    !GX(1) = "setp(ax, yticks=[])"
    ELSE IF((I.EQ.1).AND.(ACCESSID.EQ.4)) THEN
     GFC(PLTSFIGNUM)=111
    !GFC(PLTFIGHOLD)=GETVALOF("NO")
    !GA(XLIMITS)="(-10,10)"
    !GA(YLIMITS)="( 40,60)"
     GA(XLABEL)="East-West (m)"
     GA(YLABEL)="Altitude (m)"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
    !GX(1) = "a = axes([.65, .6, .2, .2])"
    !GX(2) = "setp(a, xticks=[], yticks=[])"
    !GX(1) = "setp(ax, yticks=[])"
    ELSE IF(I.EQ.1) THEN
     GA(XLIMITS)=""
     GA(YLIMITS)=""
     GA(XLABEL)="East-West (m)"
     GA(YLABEL)="Altitude (m)"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
     GA(CBARTITLE)="$\delta{n_e}$(%)"
    END IF
    IF(SPCDIMS.GT.1) THEN
     GA(ZLIMITS)=""
    END IF
    GA(XTICKSFMT)="7.3f"
    GA(YTICKSFMT)="7.3f"
   !GA(XTICKSROT)="45"
    GA(YTICKSROT)=""
    GA(XTICKSfs)="7"
    GA(YTICKSfs)="7"
   !GA(XLABEL)="East-West (m)"
   !GA(YLABEL)="Altitude (m)"
   !GA(CBARCSCHEME)="hot"
   !GA(CBARCSCHEME)="gnuplot"
   !GA(CBARCSCHEME)="autumn"
 
 
    IF(SPCDIMS.EQ.1) THEN
     GA(YLIMITS)="(-"//TRIM(NUM2STR(I))//","//TRIM(NUM2STR(I))//")"
     IF((LYDIM.EQ.1).AND.(LZDIM.EQ.1)) CALL FORTPLOT(GFC,LX3D(:,1,1),flds(:,1,1,I),FNAME,GA,GX)
     IF((LXDIM.EQ.1).AND.(LZDIM.EQ.1)) CALL FORTPLOT(GFC,LY3D(1,:,1),flds(1,:,1,I),FNAME,GA,GX)
     IF((LXDIM.EQ.1).AND.(LYDIM.EQ.1)) CALL FORTPLOT(GFC,LZ3D(1,1,:),flds(1,1,:,I),FNAME,GA,GX)
    ELSE IF(SPCDIMS.EQ.2) THEN
     GA(ZLIMITS)="(-"//TRIM(NUM2STR(I))//","//TRIM(NUM2STR(I))//")"
     IF(LZDIM.EQ.1) CALL FORTPLOT(GFC,LX3D(:,:,1),LY3D(:,:,1),flds(:,:,1,I),FNAME,GA,GX)
     IF(LYDIM.EQ.1) CALL FORTPLOT(GFC,LX3D(:,1,:),LZ3D(:,1,:),flds(:,1,:,I),FNAME,GA,GX)
     IF(LXDIM.EQ.1) CALL FORTPLOT(GFC,LY3D(1,:,:),LZ3D(1,:,:),100.0*flds(1,:,:,I),FNAME,GA,GX)
    END IF
   END IF
   GA=""
   GX=""

!******************* K-FIELDS PLOT ****************************
   IF(kfldPLOT) THEN
!******** GFC INITIALIZATION ************
    GFC(PLTDPI)=100
    GFC(PLTFIGNUM)=PLOTID
    IF((rfldPLOT.AND.kfldPLOT)) THEN
     GFC(PLTSFIGNUM)=224
    ELSE IF(kfldPLOT) THEN
     GFC(PLTSFIGNUM)=111
    END IF
    GFC(PLTFIGHOLD)=GETVALOF("NO")
    GFC(PLTYYAXES)=GETVALOF("NO")
    GFC(DATTYPE)=GETVALOF("UNFORMATTED")
    GFC(DATSAVE)=GETVALOF("KEEP")
    GFC(PNGSAVE)=GETVALOF("DELETE")
    GFC(PDFSAVE)=GETVALOF("SAVE")
    GFC(MOVNFPS)=GETVALOF("NO")

    IF(PRESENT(kplotType)) THEN
     GA(IPLOT)=TRIM(kplotType)
    ELSE
     GA(IPLOT)="contourf"
    END IF
   !GA(TITLE)="TIME= 0.000 sec"
    write(txtRUNTIME,'(1ES9.3)') RUNTIME
    GA(TITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
    GA(TITLEfs)="8"
    IF(I.EQ.1) THEN
     GA(SUPERTITLE)="Density Spectrum"
     GA(CBARTITLE)="$\delta{n_k}$"
    ENDIF 
    IF(I.EQ.2) THEN
     GA(SUPERTITLE)="Electric Potential Spectrum"
     GA(CBARTITLE)="$\delta{\varphi_k}$"
    ENDIF
    IF(I.EQ.3) THEN
     GA(SUPERTITLE)="Ion Velocity Potential Spectrum"
     GA(CBARTITLE)="$\delta{\chi_k}$"
    ENDIF
    write(txtRUNTIME,'(1ES9.3)') RUNTIME
    GA(XLABEL)="$k_y (m^{-1})$"
    GA(YLABEL)="$k_z (m^{-1})$"
    IF(SPCDIMS.GT.1) THEN
     GA(ZLABEL)="z-axis"
     GA(CBAR)="yes"
     GA(CBARSIZE)="0.8"
!    GA(CBARTITLE)=""
    END IF
    GA(XLIMITS)=""
    GA(YLIMITS)=""
    IF(SPCDIMS.GT.1) THEN
     GA(ZLIMITS)=""
    END IF
    GA(XTICKSFMT)="3.1f"
    GA(YTICKSFMT)="3.1f"
    GA(XTICKSROT)=""
    GA(YTICKSROT)=""
    GA(XTICKSfs)="7"
    GA(YTICKSfs)="7"

    IF(SPCDIMS.EQ.1) THEN
     IF(LXDIM.NE.1) THEN
      IF(ALLOCATED(kfld1D)) DEALLOCATE(kfld1D)
      IF(ALLOCATED(exiKx1D)) DEALLOCATE(exiKx1D)
      ALLOCATE(kfld1D(LXDIM/2+1))
      ALLOCATE(exiKx1D(LXDIM))
      IF(ALLOCATED(liKx1D).EQV..FALSE.) THEN
       ALLOCATE(liKx1D(LXDIM/2+1))
       CALL KGRIDBUILDER(LX3D(:,1,1),liKx1D)
      END IF
      CALL exFFTmat(liKx1D,exIKx1D)
     !CALL FORWARDFFTW(flds(:,1,1,I),kfld1D)
      CALL FFTW(flds(:,1,1,I),kfld1D)
      CALL exFFTmat(kfld1D,exkfld(:,1,1))
      CALL FORTPLOT(GFC,AIMAG(exIKx1D),ABS(exkfld(:,1,1)),FNAME,GA,GX)
     END IF
     IF(LYDIM.NE.1) THEN
      IF(ALLOCATED(kfld1D)) DEALLOCATE(kfld1D)
      IF(ALLOCATED(exiKy1D)) DEALLOCATE(exiKy1D)
      ALLOCATE(kfld1D(LYDIM/2+1))
      ALLOCATE(exiKy1D(LYDIM))
      IF(ALLOCATED(liKy1D).EQV..FALSE.) THEN
       ALLOCATE(liKy1D(LYDIM/2+1))
       CALL KGRIDBUILDER(LY3D(1,:,1),liKy1D)
      END IF
      CALL exFFTmat(liKy1D,exIKy1D)
     !CALL FORWARDFFTW(flds(1,:,1,I),kfld1D)
      CALL FFTW(flds(1,:,1,I),kfld1D)
      CALL exFFTmat(kfld1D,exkfld(1,:,1))
      CALL FORTPLOT(GFC,AIMAG(exIKy1D),ABS(exkfld(1,:,1)),FNAME,GA,GX)
     END IF
     IF(LZDIM.NE.1) THEN
      IF(ALLOCATED(kfld1D)) DEALLOCATE(kfld1D)
      IF(ALLOCATED(exiKz1D)) DEALLOCATE(exiKz1D)
      ALLOCATE(kfld1D(LZDIM/2+1))
      ALLOCATE(exiKz1D(LZDIM))
      IF(ALLOCATED(liKz1D).EQV..FALSE.) THEN
       ALLOCATE(liKz1D(LZDIM/2+1))
       CALL KGRIDBUILDER(LZ3D(1,1,:),liKz1D)
      END IF
      CALL exFFTmat(liKz1D,exIKx1D)
     !CALL FORWARDFFTW(flds(1,1,:,I),kfld1D)
      CALL FFTW(flds(1,1,:,I),kfld1D)
      CALL exFFTmat(kfld1D,exkfld(1,1,:))
      CALL FORTPLOT(GFC,AIMAG(exIKz1D),ABS(exkfld(1,1,:)),FNAME,GA,GX)
     END IF
    ELSE IF(SPCDIMS.EQ.2) THEN
     IF(LZDIM.EQ.1) THEN
      IF(ALLOCATED(kfld2D)) DEALLOCATE(kfld2D)
      IF(ALLOCATED(exiKx2D)) DEALLOCATE(exiKx2D)
      IF(ALLOCATED(exiKy2D)) DEALLOCATE(exiKy2D)
      ALLOCATE(kfld2D(LXDIM/2+1,LYDIM))
      ALLOCATE(exiKx2D(LXDIM,LYDIM))
      ALLOCATE(exiKy2D(LXDIM,LYDIM))
      IF((ALLOCATED(liKx2D).EQV..FALSE.).AND.(ALLOCATED(liKy2D).EQV..FALSE.)) THEN
       ALLOCATE(liKx2D(LXDIM/2+1,LYDIM))
       ALLOCATE(liKy2D(LXDIM/2+1,LYDIM))
       CALL KGRIDBUILDER(LX3D(:,:,1),liKx2D)
       CALL KGRIDBUILDER(LY3D(:,:,1),liKy2D)
      END IF
      CALL exFFTmat(liKx2D,exiKx2D)
      CALL exFFTmat(liKy2D,exiKy2D)
     !CALL FORWARDFFTW(flds(:,:,1,I),kfld2D(:,:))
      CALL FFTW(flds(:,:,1,I),kfld2D(:,:))
      CALL exFFTmat(kfld2D(:,:),exkfld(:,:,1))
      CALL FORTPLOT(GFC,AIMAG(exIKx2D(D1MAT12-D1MAT23:D1MAT12+D1MAT23,D2MAT12-D2MAT23:D2MAT12+D2MAT23)), &
    &                   AIMAG(exIKy2D(D1MAT12-D1MAT23:D1MAT12+D1MAT23,D2MAT12-D2MAT23:D2MAT12+D2MAT23)), &
    &                      ABS(exkfld(D1MAT12-D1MAT23:D1MAT12+D1MAT23,D2MAT12-D2MAT23:D2MAT12+D2MAT23,1)),FNAME,GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(exIKx2D),AIMAG(exIKy2D),ABS(exkfld(:,:,1)),FNAME,GA,GX)
     END IF
     IF(LYDIM.EQ.1) THEN
      IF(ALLOCATED(kfld2D)) DEALLOCATE(kfld2D)
      IF(ALLOCATED(exiKx2D)) DEALLOCATE(exiKx2D)
      IF(ALLOCATED(exiKz2D)) DEALLOCATE(exiKz2D)
      ALLOCATE(kfld2D(LXDIM/2+1,LZDIM))
      ALLOCATE(exiKx2D(LXDIM,LZDIM))
      ALLOCATE(exiKz2D(LXDIM,LZDIM))
      IF((ALLOCATED(liKx2D).EQV..FALSE.).AND.(ALLOCATED(liKz2D).EQV..FALSE.)) THEN
       ALLOCATE(liKx2D(LXDIM/2+1,LZDIM))
       ALLOCATE(liKz2D(LXDIM/2+1,LZDIM))
       CALL KGRIDBUILDER(LX3D(:,1,:),liKx2D)
       CALL KGRIDBUILDER(LZ3D(:,1,:),liKz2D)
      END IF
      CALL exFFTmat(liKx2D,exiKx2D)
      CALL exFFTmat(liKz2D,exiKz2D)
     !CALL FORWARDFFTW(flds(:,1,:,I),kfld2D(:,:))
      CALL FFTW(flds(:,1,:,I),kfld2D(:,:))
      CALL exFFTmat(kfld2D(:,:),exkfld(:,1,:))
      CALL FORTPLOT(GFC,AIMAG(exIKx2D(D1MAT12-D1MAT23:D1MAT12+D1MAT23,  D3MAT12-D3MAT23:D3MAT12+D3MAT23)), &
    &                   AIMAG(exIKz2D(D1MAT12-D1MAT23:D1MAT12+D1MAT23,  D3MAT12-D3MAT23:D3MAT12+D3MAT23)), &
    &                      ABS(exkfld(D1MAT12-D1MAT23:D1MAT12+D1MAT23,1,D3MAT12-D3MAT23:D3MAT12+D3MAT23)),FNAME,GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(exIKx2D),AIMAG(exIKz2D),ABS(exkfld(:,1,:)),FNAME,GA,GX)
     END IF
     IF(LXDIM.EQ.1) THEN
      IF(ALLOCATED(kfld2D)) DEALLOCATE(kfld2D)
      IF(ALLOCATED(exiKy2D)) DEALLOCATE(exiKy2D)
      IF(ALLOCATED(exiKz2D)) DEALLOCATE(exiKz2D)
      ALLOCATE(kfld2D(LYDIM/2+1,LZDIM))
      ALLOCATE(exiKy2D(LYDIM,LZDIM))
      ALLOCATE(exiKz2D(LYDIM,LZDIM))
      IF((ALLOCATED(liKy2D).EQV..FALSE.).AND.(ALLOCATED(liKz2D).EQV..FALSE.)) THEN
       ALLOCATE(liKy2D(LYDIM/2+1,LZDIM))
       ALLOCATE(liKz2D(LYDIM/2+1,LZDIM))
       CALL KGRIDBUILDER(LY3D(1,:,:),liKy2D)
       CALL KGRIDBUILDER(LZ3D(1,:,:),liKz2D)
      END IF
      CALL exFFTmat(liKy2D,exiKy2D)
      CALL exFFTmat(liKz2D,exiKz2D)
     !CALL FORWARDFFTW(flds(1,:,:,I),kfld2D(:,:))
      CALL FFT(flds(1,:,:,I),kfld2D(:,:))
!     CALL rmFFTalias(kfld2D)
      CALL exFFTmat(kfld2D(:,:),exkfld(1,:,:))
      CALL FORTPLOT(GFC,AIMAG(exIKy2D(2:LYDIM-1,2:LZDIM-1)),AIMAG(exIKz2D(2:LYDIM-1,2:LZDIM-1)),ABS(exkfld(1,2:LYDIM-1,2:LZDIM-1)),FNAME,GA,GX)
     END IF
    END IF
   END IF
   GA=""
   GX=""

!****** K-FIELDS ENERGY SPECTRUM PLOT ******
   IF(efldPLOT) THEN
!******** GFC INITIALIZATION ************
    GFC(PLTDPI)=100
    GFC(PLTFIGNUM)=PLOTID
    GFC(PLTFIGHOLD)=GETVALOF("YES")
    GFC(PLTYYAXES)=GETVALOF("NO")
    GFC(DATTYPE)=GETVALOF("UNFORMATTED")
    GFC(DATSAVE)=GETVALOF("REMOVE")
    GFC(PNGSAVE)=GETVALOF("DELETE")
    GFC(PDFSAVE)=GETVALOF("SAVE")
    GFC(MOVNFPS)=GETVALOF("NO")

    IF(I.EQ.1) THEN
     GA(YLABEL)="$E_{n_k}$"
    ELSE IF(I.EQ.2) THEN
     GA(YLABEL)="$E_{\phi_k}$"
    ELSE IF (I.EQ.3) THEN
     GA(YLABEL)="$E_{\chi_k}$"
    END IF
    IF(I.EQ.Lnfld) GA(XLABEL)="$(k_y,k_z)$"
   !GA(IPLOT)="loglog"
    GA(LEGEND)="yes"
    GA(LEGENDPOS)="best"
    GA(LEGENDfs)="7"
   !write(txtRUNTIME,'(1ES9.3)') RUNTIME
   !GA(SUPERTITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
   !GA(TITLE)="TIME= 0.000 sec"

    IF(LXDIM.EQ.1) THEN
     IF(ALLOCATED(kfld2D).EQV..FALSE.) ALLOCATE(kfld2D(LYDIM/2+1,LZDIM))
     IF((ALLOCATED(liKy2D).EQV..FALSE.).AND.(ALLOCATED(liKz2D).EQV..FALSE.)) THEN
      ALLOCATE(liKy2D(LYDIM/2+1,LZDIM))
      ALLOCATE(liKz2D(LYDIM/2+1,LZDIM))
      CALL KGRIDBUILDER(LY3D(1,:,:),liKy2D)
      CALL KGRIDBUILDER(LZ3D(1,:,:),liKz2D)
     END IF
    !CALL FORWARDFFTW(flds(1,:,:,I),kfld2D(:,:))
     CALL FFTW(flds(1,:,:,I),kfld2D(:,:))
     IF(ALLOCATED(FLDENERGY).EQV..FALSE.) ALLOCATE(FLDENERGY(D2MAT23))
     IF(I.EQ.1) THEN
      GFC(PLTSFIGNUM)=311
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1))
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2))
      CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.2) THEN
      GFC(PLTSFIGNUM)=312
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1))
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2))
      CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.3) THEN
      GFC(PLTSFIGNUM)=313
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1))
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GFC(PLTFIGHOLD)=GETVALOF("NO")
     !GA(SUPERTITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
      GA(SUPERTITLE)="TIME= 0.000 sec"
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_y,k_z}$"
      FLDENERGY=SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2)/MAXVAL(SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2))
      CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),FLDENERGY,"FES",GA,GX)
     !CALL FORTPLOT(GFC,AIMAG(liKy2D(1:D2MAT23,1)),SUM(REAL(kfld2D(1:D2MAT23,1:D3MAT23)*CONJG(kfld2D(1:D2MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     END IF
    ELSE IF(LYDIM.EQ.1) THEN
     IF(ALLOCATED(kfld2D).EQV..FALSE.) ALLOCATE(kfld2D(LXDIM/2+1,LZDIM))
     IF((ALLOCATED(liKx2D).EQV..FALSE.).AND.(ALLOCATED(liKz2D).EQV..FALSE.)) THEN
      ALLOCATE(liKx2D(LXDIM/2+1,LZDIM))
      ALLOCATE(liKz2D(LXDIM/2+1,LZDIM))
      CALL KGRIDBUILDER(LX3D(:,1,:),liKx2D)
      CALL KGRIDBUILDER(LZ3D(:,1,:),liKz2D)
     END IF
    !CALL FORWARDFFTW(flds(:,1,:,I),kfld2D(:,:))
     CALL FFTW(flds(:,1,:,I),kfld2D(:,:))
     IF(I.EQ.1) THEN
      GFC(PLTSFIGNUM)=311
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.2) THEN
      GFC(PLTSFIGNUM)=312
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.3) THEN
      GFC(PLTSFIGNUM)=313
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKz2D(1,1:D3MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),1),"FES",GA,GX)
      GFC(PLTFIGHOLD)=GETVALOF("NO")
      GA(SUPERTITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
      GA(IPLOTLABEL)="$\sum_{k_z}E_{k_x,k_z}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D3MAT23)*CONJG(kfld2D(1:D1MAT23,1:D3MAT23)),8),2),"FES",GA,GX)
     END IF
    ELSE IF(LZDIM.EQ.1) THEN
     IF(ALLOCATED(kfld2D).EQV..FALSE.) ALLOCATE(kfld2D(LXDIM/2+1,LYDIM))
     IF((ALLOCATED(liKx2D).EQV..FALSE.).AND.(ALLOCATED(liKy2D).EQV..FALSE.)) THEN
      ALLOCATE(liKx2D(LXDIM/2+1,LYDIM))
      ALLOCATE(liKz2D(LXDIM/2+1,LYDIM))
      CALL KGRIDBUILDER(LX3D(:,:,1),liKx2D)
      CALL KGRIDBUILDER(LY3D(:,:,1),liKy2D)
     END IF
    !CALL FORWARDFFTW(flds(:,:,1,I),kfld2D(:,:))
     CALL FFTW(flds(:,:,1,I),kfld2D(:,:))
     IF(I.EQ.1) THEN
      GFC(PLTSFIGNUM)=311
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liKy2D(1,1:D2MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.2) THEN
      GFC(PLTSFIGNUM)=312
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liKy2D(1,1:D2MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),1),"FES",GA,GX)
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),2),"FES",GA,GX)
     ELSE IF(I.EQ.3) THEN
      GFC(PLTSFIGNUM)=313
      GA(IPLOTLABEL)="$\sum_{k_x}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liky2D(1,1:D2MAT23)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),1),"FES",GA,GX)
      GFC(PLTFIGHOLD)=GETVALOF("NO")
      GA(SUPERTITLE)="RUNTIME: "//TRIM(txtRUNTIME)//" (sec)"
      GA(IPLOTLABEL)="$\sum_{k_y}E_{k_x,k_y}$"
      CALL FORTPLOT(GFC,AIMAG(liKx2D(1:D1MAT23,1)),SUM(REAL(kfld2D(1:D1MAT23,1:D2MAT23)*CONJG(kfld2D(1:D1MAT23,1:D2MAT23)),8),2),"FES",GA,GX)
     END IF
    END IF
   END IF
  END DO

  ACCESSID=ACCESSID+1
  RETURN
 END SUBROUTINE r8r8FieldsPlot

!********************************************************************
!                  PREPARE THE K-FIELDS MATRICES
!********************************************************************

 SUBROUTINE C8exFFTmat1D(kARRAY,rARRAY)
  IMPLICIT NONE
  COMPLEX(8) :: kARRAY(:),rARRAY(:)
  INTEGER(4) :: MATDIMS(1)
  INTEGER(4) :: D1MAT12,D2MAT12
  INTEGER(4) :: LXDIM

  MATDIMS=SIZE(rARRAY)
  LXDIM=MATDIMS(1)
  D1MAT12=MATDIMS(1)/2+1

  rARRAY(D1MAT12:LXDIM)=kARRAY(1:D1MAT12-1)
  rARRAY(1:D1MAT12-1)=ROT180(CONJG(kARRAY(1:D1MAT12-1)))

 END SUBROUTINE C8exFFTmat1D

 SUBROUTINE C8exFFTmat2D(kARRAY,rARRAY)
  IMPLICIT NONE
  COMPLEX(8) :: kARRAY(:,:),rARRAY(:,:)
  INTEGER(4) :: MATDIMS(2)
  INTEGER(4) :: D1MAT12,D2MAT12
  INTEGER(4) :: LXDIM,LYDIM

  MATDIMS=SHAPE(rARRAY)
  LXDIM=MATDIMS(1)
  LYDIM=MATDIMS(2)
  D1MAT12=MATDIMS(1)/2+1
  D2MAT12=MATDIMS(2)/2+1

  rARRAY(D1MAT12:LXDIM,D2MAT12:LYDIM)=kARRAY(1:D1MAT12-1,1:D2MAT12-1)
  rARRAY(D1MAT12:LXDIM,1:D2MAT12-1)=kARRAY(1:D1MAT12-1,D2MAT12:LYDIM)
  rARRAY(1:D1MAT12-1,1:D2MAT12-1)=ROT180(CONJG(kARRAY(1:D1MAT12-1,1:D2MAT12-1)))
  rARRAY(1:D1MAT12-1,D2MAT12:LYDIM)=ROT180(CONJG(kARRAY(1:D1MAT12-1,D2MAT12:LYDIM)))

 END SUBROUTINE C8exFFTmat2D

 SUBROUTINE C8exFFTmat3D(kARRAY,rARRAY)
  IMPLICIT NONE
  COMPLEX(8) :: kARRAY(:,:,:),rARRAY(:,:,:)
  INTEGER(4) :: MATDIMS(3)
  INTEGER(4) :: D1MAT12,D2MAT12,D3MAT12
  INTEGER(4) :: LXDIM,LYDIM,LZDIM

  MATDIMS=SHAPE(rARRAY)
  LXDIM=MATDIMS(1)
  LYDIM=MATDIMS(2)
  LXDIM=MATDIMS(3)
  D1MAT12=MATDIMS(1)/2+1
  D2MAT12=MATDIMS(2)/2+1
  D3MAT12=MATDIMS(3)/2+1

  rARRAY(D1MAT12:LXDIM,D2MAT12:LYDIM,1)=kARRAY(1:D1MAT12-1,1:D2MAT12-1,1)
  rARRAY(D1MAT12:LXDIM,1:D2MAT12-1,1)=kARRAY(1:D1MAT12-1,D2MAT12:LYDIM,1)
  rARRAY(1:D1MAT12-1,1:D2MAT12-1,1)=ROT180(CONJG(kARRAY(1:D1MAT12-1,1:D2MAT12-1,1)))
  rARRAY(1:D1MAT12-1,D2MAT12:LYDIM,1)=ROT180(CONJG(kARRAY(1:D1MAT12-1,D2MAT12:LYDIM,1)))

 END SUBROUTINE C8exFFTmat3D


END MODULE SYSGRAPHICS

